
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - Ma Boutique √âl√©gante</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="oda.jpg">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="/notifications.js"></script>
</head>
<body>
    <!-- Menu Hamburger Overlay -->
    <div class="hamburger-overlay" id="hamburgerOverlay">üìù</div>
    
    <!-- Menu Hamburger -->
    <div class="hamburger-menu" id="hamburgerMenu">
        <div class="hamburger-header">
            <div class="brand-section">
                <div class="logo-image">üìù</div>
                <h1 class="brand-name">ODA</h1>
            </div>
            <button class="close-menu" id="closeMenu">
                <span>√ó</span>
            </button>
        </div>
        
        <nav class="hamburger-nav">
            <a href="#" class="hamburger-link active">
                <span class="link-icon">üìä</span>
                <span>Tableau de bord</span>
            </a>
            <a href="produit.html" class="hamburger-link">
                <span class="link-icon">üì¶</span>
                <span>Produits</span>
            </a>
            <a href="commandes.html" class="hamburger-link">
                <span class="link-icon">üìã</span>
                <span>Commandes</span>
            </a>
            <a href="clients.html" class="hamburger-link">
                <span class="link-icon">üë•</span>
                <span>Clients</span>
            </a>
            <a href="messages.html" class="hamburger-link">
                <span class="link-icon">üí¨</span>
                <span>Messages</span>
            </a>
            
            <div class="hamburger-divider"></div>
            
            <a href="statitique.html" class="hamburger-link">
                <span class="link-icon">üìä</span>
                <span>Statistiques</span>
            </a>
            <a href="parametres.html" class="hamburger-link">
                <span class="link-icon">‚öôÔ∏è</span>
                <span>Param√®tres</span>
            </a>
            <a href="boutique.html" class="hamburger-link">
                <span class="link-icon">üè™</span>
                <span>Voir ma boutique</span>
            </a>
        </nav>
        
        <a href="https://whatsapp.com/channel/0029Vb6mcUm5q08htMMdVA2v" class="modern-link whatsapp">
            <svg class="link-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z" fill="currentColor"/>
                <path d="M20.52 3.449C18.24 1.245 15.24 0 12.045 0 5.463 0 .104 5.334.101 11.893c0 2.096.549 4.14 1.595 5.945L0 24l6.335-1.652c1.746.943 3.71 1.444 5.71 1.447h.006c6.585 0 11.946-5.336 11.949-11.896 0-3.176-1.24-6.165-3.48-8.4zm-8.475 18.3c-1.778 0-3.52-.478-5.038-1.378l-.36-.214-3.746.977.999-3.648-.235-.374c-.99-1.575-1.515-3.396-1.515-5.261.003-5.45 4.436-9.884 9.9-9.884 2.64 0 5.122 1.03 6.988 2.898 1.867 1.869 2.893 4.352 2.89 6.988-.002 5.453-4.437 9.896-9.883 9.896z" fill="currentColor"/>
            </svg>
            <span>Rejoindre notre cha√Æne</span>
        </a>
        
        <a href="https://t.me/+hqymnTrseaU2OWRk" class="modern-link telegram">
            <svg class="link-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z" fill="currentColor"/>
            </svg>
            <span>Rejoindre notre groupe Telegram</span>
        </a>
    </div>

    <header class="main-header">
        <div class="header-container">
            <button class="hamburger-btn" id="hamburgerBtn">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <div class="brand-section">
                <h1 class="brand-name"> Oda</h1>
            </div>

            <div class="header-actions">
                <div class="user-profile">
                    <span class="user-name">Admin</span>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar-left">
            <div class="action-section">
                <button class="btn-new-product">
                    <span>+</span>
                    <span>Nouveau produit</span>
                </button>
            </div>

            <section class="kpi-section">
                <h2 class="sidebar-title">Aujourd'hui</h2>
                <div class="kpi-card">
                    <div class="kpi-icon">üí∞</div>
                    <div class="kpi-content">
                        <p class="kpi-label">Chiffre d'affaires</p>
                        <p class="kpi-value">0 FCFA</p>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üì¶</div>
                    <div class="kpi-content">
                        <p class="kpi-label">Commandes</p>
                        <p class="kpi-value">0</p>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">üõçÔ∏è</div>
                    <div class="kpi-content">
                        <p class="kpi-label">produits</p>
                        <p class="kpi-value">0</p>
                    </div>
                </div>
            </section>
        </aside>

        <main class="main-content">
            <div class="page-header">
                <h2 class="page-title">Ajouter un nouveau produit</h2>
                <p class="page-subtitle">Compl√©tez les informations ci-dessous pour cr√©er votre produit</p>
            </div>

            <form class="product-form" id="productForm">
                <section class="form-section">
                    <h3 class="section-title">üì∏ Image principale du produit</h3>
                    <p class="section-description">Ajoutez l'image principale qui repr√©sentera votre produit</p>
                    
                    <div class="image-upload-container">
                        <label for="productMainImage" class="upload-label">
                            <div class="upload-zone">
                                <div class="upload-icon">üì∏</div>
                                <p class="upload-text">Cliquez pour ajouter l'image principale</p>
                                <p class="upload-hint">PNG, JPG jusqu'√† 5MB</p>
                            </div>
                        </label>
                        <input type="file" id="productMainImage" accept="image/*" style="display: none;">
                        
                        <div id="mainImagePreview">
                            <div class="image-preview-wrapper">
                                <img id="mainImagePreviewImg">
                                <button type="button" id="removeMainImage" class="remove-image-btn">√ó</button>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="form-section">
                    <h3 class="section-title">üìù Informations de base</h3>
                    
                    <div class="form-group">
                        <label class="form-label">Nom du produit <span class="required">*</span></label>
                        <input type="text" id="productName" class="form-input" placeholder="Ex: Robe √©l√©gante fleurie" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Description <span class="required">*</span></label>
                        <textarea id="productDescription" class="form-textarea" placeholder="D√©crivez votre produit en d√©tail..." required></textarea>
                    </div>

                    <div class="description-images-section">
                        <h4 class="description-images-title">üñºÔ∏è Images de description (Maximum 3)</h4>
                        <p class="description-images-hint">Ajoutez jusqu'√† 3 images pour illustrer votre description produit</p>
                        
                        <div class="description-images-grid" id="descriptionImagesGrid">
                            <div class="description-image-slot" data-slot="1">
                                <div class="description-image-placeholder">
                                    <div class="description-image-icon">üñºÔ∏è</div>
                                    <p>Image 1</p>
                                </div>
                                <input type="file" accept="image/*" style="display: none;" class="desc-image-input">
                            </div>
                            
                            <div class="description-image-slot" data-slot="2">
                                <div class="description-image-placeholder">
                                    <div class="description-image-icon">üñºÔ∏è</div>
                                    <p>Image 2</p>
                                </div>
                                <input type="file" accept="image/*" style="display: none;" class="desc-image-input">
                            </div>
                            
                            <div class="description-image-slot" data-slot="3">
                                <div class="description-image-placeholder">
                                    <div class="description-image-icon">üñºÔ∏è</div>
                                    <p>Image 3</p>
                                </div>
                                <input type="file" accept="image/*" style="display: none;" class="desc-image-input">
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Prix (FCFA) <span class="required">*</span></label>
                            <input type="number" id="productPrice" class="form-input" placeholder="15000" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Stock <span class="required">*</span></label>
                            <input type="number" id="productStock" class="form-input" placeholder="50" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Cat√©gorie <span class="required">*</span></label>
                        <select id="productCategory" class="form-select" required>
                            <option value="">S√©lectionnez une cat√©gorie</option>
                            <option value="Vetements">Vetements</option>
                            <option value="Electroniques">Electroniques</option>
                            <option value="Decoration">Decoration</option>
                            <option value="Accessoires">Accessoires</option>
                            <option value="Electromenager">Electromenager</option>
                            <option value="Beaute & soin">Beaute & soin</option>
                            <option value="Accessoires">Accessoires</option>
                            <option value="Bebe">Bebe</option>
                            <option value="jeux & jouets">jeux & jouets</option>
                            <option value="Bricolage">Bricolage</option>
                            <option value="Alimentation">Alimentation</option>
                            <option value="Boissons">Boissons</option>
                            <option value="Livre">Livre</option>
                            <option value="Hygiene & sante">Hygiene & sante</option>
                            <option value="fitness">fitness</option>
                            <option value="Animaux">Animaux</option>
                            <option value="Luxe">Luxe</option>
                            <option value="Bureau">Bureau</option>
                        </select>
                    </div>
                </section>

                <section class="form-section">
                    <h3 class="section-title">üöÄ Statut de publication</h3>
                    
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="statusPublished" name="productStatus" value="published" checked>
                            <label for="statusPublished" class="radio-label">
                                <span class="radio-custom"></span>
                                <div>
                                    <strong>Publi√©</strong>
                                    <p>Le produit sera visible sur votre boutique</p>
                                </div>
                            </label>
                        </div>

                        <div class="radio-item">
                            <input type="radio" id="statusDraft" name="productStatus" value="draft">
                            <label for="statusDraft" class="radio-label">
                                <span class="radio-custom"></span>
                                <div>
                                    <strong>Brouillon</strong>
                                    <p>Le produit ne sera pas visible publiquement</p>
                                </div>
                            </label>
                        </div>
                    </div>
                </section>

                <div class="form-actions">
                    <button type="button" class="btn-secondary">Aper√ßu</button>
                    <button type="submit" class="btn-primary">Enregistrer le produit</button>
                </div>
            </form>
        </main>

        <aside class="sidebar-right">
            <section class="preview-section">
                <h3 class="sidebar-title">üëÅÔ∏è Aper√ßu du produit</h3>
                
                <div class="product-preview-card">
                    <div class="preview-image-container">
                        <div class="preview-placeholder">
                            <p>üñºÔ∏è</p>
                            <p>Image principale</p>
                        </div>
                    </div>
                    
                    <div class="preview-content">
                        <h4 class="preview-title" id="previewTitle">Nom du produit</h4>
                        <p class="preview-description" id="previewDescription">La description appara√Ætra ici...</p>
                        
                        <div id="previewDescImages"></div>
                        
                        <p class="preview-price" id="previewPrice">0 FCFA</p>
                    </div>
                </div>
            </section>
        </aside>
    </div>
<script type="module">
    // ==================== CONFIGURATION SUPABASE ====================
const SUPABASE_URL = 'https://xjckbqbqxcwzcrlmuvzf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqY2ticWJxeGN3emNybG11dnpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTk1MzMsImV4cCI6MjA3NjA5NTUzM30.AMzAUwtjFt7Rvof5r2enMyYIYToc1wNWWEjvZqK_YXM';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ==================== VARIABLES GLOBALES ====================
let produits = [];
let descriptionImages = [null, null, null];
let mainImage = null;
let produitEnEdition = null;
let currentUser = null;
let abonnementActuel = null;

// ==================== INITIALISATION ====================
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üå∏ Tableau de bord initialis√© !');
    
    await verifierAuthentification();
    initialiserMenuHamburger();
    await verifierConfiguration();
    initialiserEvenements();
    await initialiserSystemeAbonnement();
    await chargerProduits();
    await chargerStatistiques();
    await verifierEditionDepuisLocalStorage();
    await afficherStatutAbonnement();
    ajouterBoutonAbonnement();
});

// ==================== AUTHENTIFICATION ====================
async function verifierAuthentification() {
    try {
        const { data: { session }, error } = await supabase.auth.getSession();
        
        if (error) throw error;
        
        if (!session) {
            console.warn('‚ö†Ô∏è Aucune session active');
            window.location.href = 'connexion.html';
            return;
        }
        
        currentUser = session.user;
        console.log('‚úÖ Utilisateur connect√©:', currentUser.email);
        
        const userNameElement = document.querySelector('.user-name');
        if (userNameElement) {
            userNameElement.textContent = currentUser.email.split('@')[0];
        }
        
    } catch (error) {
        console.error('‚ùå Erreur authentification:', error);
        window.location.href = 'connexion.html';
    }
}

// ==================== MENU HAMBURGER ====================
function initialiserMenuHamburger() {
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const hamburgerMenu = document.getElementById('hamburgerMenu');
    const hamburgerOverlay = document.getElementById('hamburgerOverlay');
    const closeMenu = document.getElementById('closeMenu');
    
    if (hamburgerBtn) {
        hamburgerBtn.addEventListener('click', () => {
            hamburgerBtn.classList.toggle('active');
            hamburgerMenu?.classList.toggle('active');
            hamburgerOverlay?.classList.toggle('active');
            document.body.style.overflow = 'hidden';
        });
    }
    
    const fermerMenu = () => {
        hamburgerBtn?.classList.remove('active');
        hamburgerMenu?.classList.remove('active');
        hamburgerOverlay?.classList.remove('active');
        document.body.style.overflow = '';
    };
    
    if (closeMenu) {
        closeMenu.addEventListener('click', fermerMenu);
    }
    
    if (hamburgerOverlay) {
        hamburgerOverlay.addEventListener('click', fermerMenu);
    }
    
    const hamburgerLinks = document.querySelectorAll('.hamburger-link');
    hamburgerLinks.forEach(link => {
        link.addEventListener('click', () => {
            setTimeout(fermerMenu, 300);
        });
    });
    
    console.log('üì± Menu hamburger initialis√©');
}

// ==================== V√âRIFICATION CONFIGURATION ====================
async function verifierConfiguration() {
    try {
        console.log('üîç V√©rification de la configuration Supabase...');
        
        const { data, error } = await supabase
            .from('produits')
            .select('count')
            .limit(1);

        if (error) {
            console.error('‚ùå Erreur de connexion:', error);
            if (error.code === 'PGRST116') {
                afficherNotification('‚ö†Ô∏è La table "produits" n\'existe pas.', 'warning');
            } else if (error.message.includes('JWT')) {
                afficherNotification('‚ö†Ô∏è Erreur d\'authentification.', 'warning');
            }
        } else {
            console.log('‚úÖ Connexion Supabase r√©ussie !');
        }

    } catch (error) {
        console.error('‚ùå Erreur lors de la v√©rification:', error);
    }
}

// ==================== BOUTON ABONNEMENT ====================
function ajouterBoutonAbonnement() {
    const headerActions = document.querySelector('.header-actions');
    if (!headerActions || document.getElementById('btn-abonnement')) return;

    const btnAbonnement = document.createElement('a');
    btnAbonnement.id = 'btn-abonnement';
    btnAbonnement.href = 'abonnement.html';
    btnAbonnement.style.cssText = `
        padding: 10px 20px;
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
        box-shadow: 0 4px 12px rgba(255, 165, 0, 0.3);
    `;
    btnAbonnement.innerHTML = 'üóìÔ∏è Abonnements';

    btnAbonnement.addEventListener('mouseover', () => {
        btnAbonnement.style.transform = 'translateY(-2px)';
        btnAbonnement.style.boxShadow = '0 6px 16px rgba(255, 165, 0, 0.4)';
    });

    btnAbonnement.addEventListener('mouseout', () => {
        btnAbonnement.style.transform = 'translateY(0)';
        btnAbonnement.style.boxShadow = '0 4px 12px rgba(255, 165, 0, 0.3)';
    });

    headerActions.appendChild(btnAbonnement);
}
// ==================== SYST√àME D'ABONNEMENT ====================

// ‚úÖ FONCTION 1: V√©rifier le quota avant publication
async function verifierQuotaAvantPublication(produitId = null) {
    try {
        const { data: abo, error: aboError } = await supabase
            .from('abonnements')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();

        let limite = 10;
        let planActif = false;
        
        if (abo && !aboError) {
            const expiration = new Date(abo.date_expiration);
            const maintenant = new Date();
            
            if (expiration > maintenant) {
                limite = abo.limite_produits;
                planActif = true;
                console.log(`‚úÖ Abonnement ${abo.plan} actif: ${limite} produits max`);
            } else {
                console.log(`‚ö†Ô∏è Abonnement expir√©, retour au plan gratuit: ${limite} produits max`);
            }
        } else {
            console.log(`üìä Plan gratuit: ${limite} produits max`);
        }

        const { data: produits, error: countError } = await supabase
            .from('produits')
            .select('id')
            .eq('user_id', currentUser.id)
            .eq('statut', 'published');

        if (countError) throw countError;

        let nombrePublies = produits ? produits.length : 0;
        
        if (produitId) {
            const produitExiste = produits?.find(p => p.id === produitId);
            if (produitExiste) {
                nombrePublies--;
            }
        }

        const restant = limite - nombrePublies;
        const peutPublier = nombrePublies < limite;

        console.log(`üìä Quota actuel: ${nombrePublies}/${limite} produits publi√©s (${restant} restant${restant > 1 ? 's' : ''})`);

        return {
            peutPublier,
            nombrePublies,
            limite,
            restant,
            planActif
        };
        
    } catch (error) {
        console.error('‚ùå Erreur v√©rification quota:', error);
        return { 
            peutPublier: false, 
            nombrePublies: 0, 
            limite: 10, 
            restant: 10,
            planActif: false 
        };
    }
}
async function verifierAlertesAbonnement() {
    if (!currentUser) return;
    
    try {
        const { data: abo, error } = await supabase
            .from('abonnements')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();
        
        if (abo && !error) {
            const expiration = new Date(abo.date_expiration);
            const maintenant = new Date();
            const joursRestants = Math.ceil((expiration - maintenant) / (1000 * 60 * 60 * 24));
            
            // Abonnement expire dans 7 jours ou moins
            if (joursRestants > 0 && joursRestants <= 7) {
                if (window.notificationManager) {
                    window.notificationManager.notifySubscriptionAlert({
                        type: 'expiring_soon',
                        plan: abo.plan,
                        daysLeft: joursRestants
                    });
                }
            }
            
            // Abonnement expir√©
            if (joursRestants <= 0) {
                if (window.notificationManager) {
                    window.notificationManager.notifySubscriptionAlert({
                        type: 'expired',
                        plan: abo.plan
                    });
                }
            }
        }
        
        // V√©rifier quota produits
        const quota = await verifierQuotaAvantPublication();
        
        // Limite atteinte
        if (quota.restant === 0) {
            if (window.notificationManager) {
                window.notificationManager.notifySubscriptionAlert({
                    type: 'quota_reached',
                    count: quota.nombrePublies,
                    limit: quota.limite
                });
            }
        }
        
        // Produits en danger (brouillons anciens)
        const date7Jours = new Date();
        date7Jours.setDate(date7Jours.getDate() - 7);
        
        const date14Jours = new Date();
        date14Jours.setDate(date14Jours.getDate() - 14);
        
        const { data: produitsEnDanger } = await supabase
            .from('produits')
            .select('id')
            .eq('user_id', currentUser.id)
            .eq('statut', 'draft')
            .not('date_draft', 'is', null)
            .lt('date_draft', date7Jours.toISOString())
            .gte('date_draft', date14Jours.toISOString());
        
        if (produitsEnDanger && produitsEnDanger.length > 0) {
            const joursRestants = produitsEnDanger.map(p => {
                const joursBrouillon = Math.floor((new Date() - new Date(p.date_draft)) / (1000 * 60 * 60 * 24));
                return 14 - joursBrouillon;
            });
            const minJours = Math.min(...joursRestants);
            
            if (window.notificationManager) {
                window.notificationManager.notifySubscriptionAlert({
                    type: 'products_at_risk',
                    count: produitsEnDanger.length,
                    daysLeft: minJours
                });
            }
        }
        
    } catch (error) {
        console.error('‚ùå Erreur v√©rification alertes:', error);
    }
}

// V√©rifier toutes les heures
setInterval(verifierAlertesAbonnement, 60 * 60 * 1000);

// V√©rifier au chargement
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(verifierAlertesAbonnement, 5000); // Attendre 5s
});
function ajouterBoutonNotifications() {
    const container = document.querySelector('.header-actions');
    if (!container || document.getElementById('btn-notifications')) return;
    
    const btn = document.createElement('button');
    btn.id = 'btn-notifications';
    btn.className = 'icon-btn';
    btn.innerHTML = 'üîî';
    btn.title = 'Activer les notifications';
    
    btn.style.cssText = `
        position: relative;
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        color: white;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        font-size: 1.2rem;
    `;
    
    btn.addEventListener('click', async () => {
        if (window.notificationManager) {
            if (Notification.permission === 'default') {
                const granted = await window.notificationManager.requestPermission();
                if (granted) {
                    btn.innerHTML = 'üîî';
                    btn.style.background = 'linear-gradient(135deg, #34C759 0%, #4CAF50 100%)';
                    afficherNotification('‚úÖ Notifications activ√©es !', 'success');
                }
            } else if (Notification.permission === 'granted') {
                afficherNotification('‚úÖ Notifications d√©j√† activ√©es', 'success');
            } else {
                alert('‚ùå Notifications bloqu√©es. Autorisez-les dans les param√®tres du navigateur.');
            }
        }
    });
    
    // Changer la couleur selon l'√©tat
    if (Notification.permission === 'granted') {
        btn.style.background = 'linear-gradient(135deg, #34C759 0%, #4CAF50 100%)';
    } else if (Notification.permission === 'denied') {
        btn.style.background = 'linear-gradient(135deg, #FF3B30 0%, #CC2F26 100%)';
    }
    
    container.appendChild(btn);
}

// Appeler au chargement
document.addEventListener('DOMContentLoaded', ajouterBoutonNotifications);
// ‚úÖ FONCTION 2: G√©rer les produits expir√©s
async function gererProduitsExpires() {
    try {
        if (!currentUser) return;

        const { data: abo, error: aboError } = await supabase
            .from('abonnements')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();

        if (aboError && aboError.code !== 'PGRST116') {
            console.error('Erreur r√©cup√©ration abonnement:', aboError);
            return;
        }

        if (!abo || new Date(abo.date_expiration) <= new Date()) {
            console.log('‚ö†Ô∏è Pas d\'abonnement actif - Application limite gratuite');
            
            const { data: produitsPublies, error: fetchError } = await supabase
                .from('produits')
                .select('id, created_at')
                .eq('user_id', currentUser.id)
                .eq('statut', 'published')
                .order('created_at', { ascending: false });

            if (fetchError) throw fetchError;

            if (!produitsPublies || produitsPublies.length <= 10) {
                return;
            }

            const produitsADrafter = produitsPublies.slice(10);
            const idsADrafter = produitsADrafter.map(p => p.id);

            const { error: updateError } = await supabase
                .from('produits')
                .update({ 
                    statut: 'draft',
                    date_draft: new Date().toISOString()
                })
                .in('id', idsADrafter);

            if (updateError) throw updateError;

            console.log(`üì¶ ${produitsADrafter.length} produit(s) mis en brouillon`);
        }
    } catch (error) {
        console.error('‚ùå Erreur gestion produits expir√©s:', error);
    }
}

// ‚úÖ FONCTION 3: Supprimer les produits anciens (>14 jours)
async function supprimerProduitsAnciens() {
    try {
        if (!currentUser) return;

        const dateLimite = new Date();
        dateLimite.setDate(dateLimite.getDate() - 14);
        const dateLimiteISO = dateLimite.toISOString();

        console.log(`üóëÔ∏è Recherche des produits en brouillon depuis plus de 14 jours`);

        const { data: produitsASupprimer, error: fetchError } = await supabase
            .from('produits')
            .select('id, nom, date_draft, created_at')
            .eq('user_id', currentUser.id)
            .eq('statut', 'draft')
            .not('date_draft', 'is', null)
            .lt('date_draft', dateLimiteISO);

        if (fetchError) throw fetchError;

        if (!produitsASupprimer || produitsASupprimer.length === 0) {
            console.log('‚ÑπÔ∏è Aucun produit ancien √† supprimer');
            return;
        }

        console.log(`‚ö†Ô∏è ${produitsASupprimer.length} produit(s) √† supprimer`);

        const ids = produitsASupprimer.map(p => p.id);
        const { error: deleteError } = await supabase
            .from('produits')
            .delete()
            .in('id', ids);

        if (deleteError) throw deleteError;

        console.log(`‚úÖ ${produitsASupprimer.length} produit(s) supprim√©s automatiquement`);
        
        afficherNotification(
            `üóëÔ∏è ${produitsASupprimer.length} produit(s) en brouillon depuis plus de 14 jours ont √©t√© supprim√©s`,
            'info'
        );

    } catch (error) {
        console.error('‚ùå Erreur suppression produits anciens:', error);
    }
}

// ‚úÖ FONCTION 4: Afficher avertissement produits en danger
async function afficherAvertissementProduitsEnDanger() {
    try {
        if (!currentUser) return;

        const date7Jours = new Date();
        date7Jours.setDate(date7Jours.getDate() - 7);
        
        const date14Jours = new Date();
        date14Jours.setDate(date14Jours.getDate() - 14);

        const { data: produitsEnDanger, error } = await supabase
            .from('produits')
            .select('id, nom, date_draft')
            .eq('user_id', currentUser.id)
            .eq('statut', 'draft')
            .not('date_draft', 'is', null)
            .lt('date_draft', date7Jours.toISOString())
            .gte('date_draft', date14Jours.toISOString());

        if (error) throw error;

        if (!produitsEnDanger || produitsEnDanger.length === 0) {
            return;
        }

        const banniere = document.createElement('div');
        banniere.id = 'warning-banner';
        banniere.style.cssText = `
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #FF9500 0%, #FF6B00 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(255, 149, 0, 0.3);
            z-index: 1500;
            max-width: 600px;
            width: 90%;
            animation: slideDown 0.5s ease;
            font-family: 'Poppins', sans-serif;
        `;

        const joursRestants = produitsEnDanger.map(p => {
            const joursBrouillon = Math.floor((new Date() - new Date(p.date_draft)) / (1000 * 60 * 60 * 24));
            return 14 - joursBrouillon;
        });
        const minJours = Math.min(...joursRestants);

        banniere.innerHTML = `
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="font-size: 2.5rem;">‚ö†Ô∏è</div>
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 8px 0; font-size: 1.1rem; font-weight: 700;">
                        Attention : Produits en danger !
                    </h3>
                    <p style="margin: 0 0 12px 0; font-size: 0.9rem; opacity: 0.95;">
                        ${produitsEnDanger.length} produit(s) seront supprim√©s dans ${minJours} jour${minJours > 1 ? 's' : ''}.
                    </p>
                    <div style="display: flex; gap: 12px;">
                        <button onclick="window.location.href='abonnement.html'" 
                                style="padding: 10px 20px; background: white; color: #FF9500; 
                                       border: none; border-radius: 10px; font-weight: 700; 
                                       cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.85rem;">
                            üîÑ R√©activer avec un abonnement
                        </button>
                        <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" 
                                style="padding: 10px 20px; background: rgba(255, 255, 255, 0.2); color: white; 
                                       border: 2px solid white; border-radius: 10px; font-weight: 600; 
                                       cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.85rem;">
                            Fermer
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(banniere);

    } catch (error) {
        console.error('‚ùå Erreur affichage avertissement:', error);
    }
}

// ‚úÖ FONCTION 5: Afficher le statut de l'abonnement
async function afficherStatutAbonnement() {
    try {
        const { data: abo, error } = await supabase
            .from('abonnements')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();

        abonnementActuel = abo;

        const quota = await verifierQuotaAvantPublication();
        
        const banniere = document.createElement('div');
        banniere.id = 'subscription-status';
        banniere.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 20px 24px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1500;
            max-width: 350px;
            animation: slideInRight 0.5s ease;
            font-family: 'Poppins', sans-serif;
        `;

        let contenu = '';
        
        if (!abo || new Date(abo.date_expiration) <= new Date()) {
            banniere.style.borderLeft = '4px solid #FF9500';
            contenu = `
                <div style="display: flex; align-items: start; gap: 12px;">
                    <div style="font-size: 2rem;">‚ö†Ô∏è</div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 8px 0; font-size: 1.1rem; font-weight: 600;">
                            Plan gratuit actif
                        </h3>
                        <p style="margin: 0 0 8px 0; color: #666; font-size: 0.9rem;">
                            ${quota.nombrePublies}/${quota.limite} produits publi√©s
                        </p>
                        <div style="background: #f0f0f0; height: 8px; border-radius: 4px; margin-bottom: 12px; overflow: hidden;">
                            <div style="background: ${quota.nombrePublies >= quota.limite ? '#FF3B30' : '#FF9500'}; height: 100%; width: ${(quota.nombrePublies / quota.limite) * 100}%; transition: width 0.3s ease;"></div>
                        </div>
                        <button onclick="window.location.href='abonnement.html'" 
                                style="width: 100%; padding: 12px; background: linear-gradient(135deg, #007AFF 0%, #5AC8FA 100%); 
                                       color: white; border: none; border-radius: 12px; font-weight: 600; 
                                       cursor: pointer; font-family: 'Poppins', sans-serif;">
                            üìã Voir les offres
                        </button>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 1.5rem; 
                                   cursor: pointer; color: #999; padding: 0; line-height: 1;">
                        √ó
                    </button>
                </div>
            `;
        } else {
            const expiration = new Date(abo.date_expiration);
            const maintenant = new Date();
            const joursRestants = Math.ceil((expiration - maintenant) / (1000 * 60 * 60 * 24));
            
            banniere.style.borderLeft = '4px solid #34C759';
            contenu = `
                <div style="display: flex; align-items: start; gap: 12px;">
                    <div style="font-size: 2rem;">‚úÖ</div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 8px 0; font-size: 1.1rem; font-weight: 600; color: #34C759;">
                            Plan ${abo.plan.toUpperCase()} actif
                        </h3>
                        <p style="margin: 0 0 8px 0; color: #666; font-size: 0.9rem;">
                            ${quota.nombrePublies}/${quota.limite} produits utilis√©s
                        </p>
                        <div style="background: #f0f0f0; height: 8px; border-radius: 4px; margin-bottom: 12px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #34C759, #4CAF50); height: 100%; width: ${(quota.nombrePublies / quota.limite) * 100}%; transition: width 0.3s ease;"></div>
                        </div>
                        <p style="margin: 0; color: #999; font-size: 0.8rem;">
                            Expire dans ${joursRestants} jour${joursRestants > 1 ? 's' : ''}
                        </p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 1.5rem; 
                                   cursor: pointer; color: #999; padding: 0; line-height: 1;">
                        √ó
                    </button>
                </div>
            `;
        }

        banniere.innerHTML = contenu;
        document.body.appendChild(banniere);

    } catch (error) {
        console.error('‚ùå Erreur affichage statut:', error);
    }
}

// ‚úÖ FONCTION 6: Initialiser le syst√®me d'abonnement
async function initialiserSystemeAbonnement() {
    try {
        console.log('üöÄ Initialisation du syst√®me d\'abonnement...');
        
        await gererProduitsExpires();
        await supprimerProduitsAnciens();
        await afficherAvertissementProduitsEnDanger();
        
        console.log('‚úÖ Syst√®me d\'abonnement initialis√© avec succ√®s');
        
    } catch (error) {
        console.error('‚ùå Erreur initialisation syst√®me:', error);
    }
}
// ==================== INITIALISATION DES √âV√âNEMENTS ====================
function initialiserEvenements() {
    const form = document.getElementById('productForm');
    if (form) {
        form.addEventListener('submit', gererSoumissionFormulaire);
    }

    document.getElementById('productName')?.addEventListener('input', mettreAJourApercu);
    document.getElementById('productDescription')?.addEventListener('input', mettreAJourApercu);
    document.getElementById('productPrice')?.addEventListener('input', mettreAJourApercu);
    document.getElementById('productStock')?.addEventListener('input', mettreAJourApercu);

    const mainImageInput = document.getElementById('productMainImage');
    if (mainImageInput) {
        mainImageInput.addEventListener('change', gererImagePrincipale);
    }

    const removeMainImageBtn = document.getElementById('removeMainImage');
    if (removeMainImageBtn) {
        removeMainImageBtn.addEventListener('click', supprimerImagePrincipale);
    }

    const slots = document.querySelectorAll('.description-image-slot');
    slots.forEach((slot, index) => {
        const input = slot.querySelector('.desc-image-input');
        
        slot.addEventListener('click', (e) => {
            if (!e.target.closest('.description-image-remove')) {
                input.click();
            }
        });

        input.addEventListener('change', (e) => {
            gererImageDescription(e, index);
        });
    });

    console.log('üéØ √âv√©nements initialis√©s');
}

// ==================== GESTION IMAGE PRINCIPALE ====================
function gererImagePrincipale(e) {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
        afficherNotification('‚ùå Veuillez s√©lectionner une image', 'error');
        return;
    }

    if (file.size > 5 * 1024 * 1024) {
        afficherNotification('‚ùå L\'image ne doit pas d√©passer 5MB', 'error');
        return;
    }

    // ‚úÖ NOUVEAU: Stocker le fichier directement au lieu du base64
    const reader = new FileReader();
    reader.onload = function(event) {
        mainImage = file; // Stocke le fichier File object
        afficherImagePrincipale(event.target.result); // Affiche avec base64 pour preview
        mettreAJourApercuPrincipal();
        afficherNotification('‚úÖ Image principale ajout√©e', 'success');
    };
    reader.readAsDataURL(file);
}

function afficherImagePrincipale(imageUrl) {
    const preview = document.getElementById('mainImagePreview');
    const previewImg = document.getElementById('mainImagePreviewImg');
    const uploadZone = document.querySelector('.upload-zone');

    if (preview && previewImg) {
        previewImg.src = imageUrl;
        preview.style.display = 'block';
        if (uploadZone) uploadZone.style.display = 'none';
    }
}

function supprimerImagePrincipale() {
    mainImage = null;
    
    const preview = document.getElementById('mainImagePreview');
    const uploadZone = document.querySelector('.upload-zone');
    const mainImageInput = document.getElementById('productMainImage');

    if (preview) preview.style.display = 'none';
    if (uploadZone) uploadZone.style.display = 'block';
    if (mainImageInput) mainImageInput.value = '';

    mettreAJourApercuPrincipal();
    afficherNotification('üóëÔ∏è Image principale supprim√©e', 'info');
}

function mettreAJourApercuPrincipal() {
    const previewContainer = document.querySelector('.preview-image-container');
    if (!previewContainer) return;

    if (mainImage) {
        // Si c'est une URL Cloudinary (√©dition)
        if (typeof mainImage === 'string') {
            previewContainer.innerHTML = `
                <img src="${mainImage}" style="width: 100%; height: 100%; object-fit: cover;" alt="Aper√ßu produit">
            `;
        } else {
            // Si c'est un fichier File (nouveau)
            const reader = new FileReader();
            reader.onload = function(e) {
                previewContainer.innerHTML = `
                    <img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;" alt="Aper√ßu produit">
                `;
            };
            reader.readAsDataURL(mainImage);
        }
    } else {
        previewContainer.innerHTML = `
            <div class="preview-placeholder">
                <p>üñºÔ∏è</p>
                <p>Image principale</p>
            </div>
        `;
    }
}

// ==================== GESTION IMAGES DESCRIPTION ====================
function gererImageDescription(e, slotIndex) {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
        afficherNotification('‚ùå Veuillez s√©lectionner une image', 'error');
        return;
    }

    if (file.size > 5 * 1024 * 1024) {
        afficherNotification('‚ùå L\'image ne doit pas d√©passer 5MB', 'error');
        return;
    }

    // ‚úÖ NOUVEAU: Stocker le fichier directement au lieu du base64
    const reader = new FileReader();
    reader.onload = function(event) {
        descriptionImages[slotIndex] = file; // Stocke le fichier File object
        afficherImageDansSlot(slotIndex, event.target.result); // Affiche avec base64 pour preview
        mettreAJourApercuImages();
        afficherNotification(`‚úÖ Image ${slotIndex + 1} ajout√©e`, 'success');
    };
    reader.readAsDataURL(file);
}

function afficherImageDansSlot(slotIndex, imageUrl) {
    const slot = document.querySelector(`.description-image-slot[data-slot="${slotIndex + 1}"]`);
    if (!slot) return;

    slot.classList.add('has-image');
    slot.innerHTML = '';

    const img = document.createElement('img');
    img.src = imageUrl;
    img.className = 'description-image-preview';
    img.alt = `Image de description ${slotIndex + 1}`;
    slot.appendChild(img);

    const removeBtn = document.createElement('button');
    removeBtn.className = 'description-image-remove';
    removeBtn.innerHTML = '√ó';
    removeBtn.type = 'button';
    removeBtn.onclick = (e) => {
        e.stopPropagation();
        supprimerImageDescription(slotIndex);
    };
    slot.appendChild(removeBtn);

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.className = 'desc-image-input';
    input.style.display = 'none';
    input.addEventListener('change', (e) => gererImageDescription(e, slotIndex));
    slot.appendChild(input);
}

function supprimerImageDescription(slotIndex) {
    descriptionImages[slotIndex] = null;
    
    const slot = document.querySelector(`.description-image-slot[data-slot="${slotIndex + 1}"]`);
    if (!slot) return;

    slot.classList.remove('has-image');
    slot.innerHTML = `
        <div class="description-image-placeholder">
            <div class="description-image-icon">üñºÔ∏è</div>
            <p style="font-size: 0.85rem;">Image ${slotIndex + 1}</p>
        </div>
        <input type="file" accept="image/*" style="display: none;" class="desc-image-input">
    `;

    const input = slot.querySelector('.desc-image-input');
    input.addEventListener('change', (e) => gererImageDescription(e, slotIndex));

    mettreAJourApercuImages();
    afficherNotification(`üóëÔ∏è Image ${slotIndex + 1} supprim√©e`, 'info');
}

function mettreAJourApercuImages() {
    const container = document.getElementById('previewDescImages');
    if (!container) return;

    container.innerHTML = '';

    const imagesNonNulles = descriptionImages.filter(img => img !== null);
    
    if (imagesNonNulles.length === 0) return;

    imagesNonNulles.forEach((image, index) => {
        const imgWrapper = document.createElement('div');
        imgWrapper.style.cssText = `
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            box-shadow: 0 2px 8px rgba(199, 125, 255, 0.2);
        `;

        const img = document.createElement('img');
        img.style.cssText = `
            width: 100%;
            height: 100%;
            object-fit: cover;
        `;
        img.alt = `Description ${index + 1}`;

        // Si c'est une URL Cloudinary (√©dition)
        if (typeof image === 'string') {
            img.src = image;
        } else {
            // Si c'est un fichier File (nouveau)
            const reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
            };
            reader.readAsDataURL(image);
        }

        imgWrapper.appendChild(img);
        container.appendChild(imgWrapper);
    });
}

// ==================== MISE √Ä JOUR APER√áU ====================
function mettreAJourApercu() {
    const nom = document.getElementById('productName')?.value || 'Nom du produit';
    const description = document.getElementById('productDescription')?.value || 'La description appara√Ætra ici...';
    const prix = document.getElementById('productPrice')?.value || '0';

    const previewTitle = document.getElementById('previewTitle');
    const previewDescription = document.getElementById('previewDescription');
    const previewPrice = document.getElementById('previewPrice');

    if (previewTitle) previewTitle.textContent = nom;
    if (previewDescription) previewDescription.textContent = description;
    if (previewPrice) {
        const prixFormate = parseInt(prix) || 0;
        previewPrice.textContent = `${prixFormate.toLocaleString('fr-FR')} FCFA`;
    }
}

// ==================== üÜï UPLOAD CLOUDINARY S√âCURIS√â ====================

/**
 * üîê Upload d'une image vers Cloudinary avec signature s√©curis√©e
 * @param {File} file - Fichier image √† uploader
 * @param {string} nomFichier - Nom identifiant pour le fichier
 * @returns {Promise<string>} URL publique de l'image sur Cloudinary
 */
// ==================== üÜï UPLOAD CLOUDINARY S√âCURIS√â (VERSION CORRIG√âE) ====================

/**
 * üîê Upload d'une image vers Cloudinary avec signature s√©curis√©e
 * @param {File} file - Fichier image √† uploader
 * @param {string} nomFichier - Nom identifiant pour le fichier
 * @returns {Promise<string>} URL publique de l'image sur Cloudinary
 */
/**
 * üì§ Upload d'une image vers Cloudinary (Unsigned Upload)
 * @param {File} file - Fichier image √† uploader
 * @param {string} nomFichier - Nom identifiant pour le fichier
 * @returns {Promise<string>} URL publique de l'image sur Cloudinary
 */
 async function uploaderImageVersCloudinary(file, nomFichier) {
    try {
        console.log(`üì§ Upload de ${nomFichier} vers Cloudinary...`);
        console.log('üìã Fichier:', {
            nom: file.name,
            type: file.type,
            taille: `${(file.size / 1024).toFixed(2)} KB`
        });
        
        
        
        const CLOUD_NAME = 'dnpeuymo0';  
        const UPLOAD_PRESET = 'oda_unsigned_upload';  
        // ‚úÖ Validation du fichier
        if (!file || !(file instanceof File)) {
            throw new Error('Fichier invalide');
        }
        
        if (!file.type.startsWith('image/')) {
            throw new Error('Le fichier doit √™tre une image');
        }
        
        const maxSize = 10 * 1024 * 1024; // 10 MB
        if (file.size > maxSize) {
            throw new Error(`L'image ne doit pas d√©passer ${maxSize / (1024 * 1024)} MB`);
        }
        
        // üì¶ Pr√©parer le FormData
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', UPLOAD_PRESET);
        formData.append('folder', `produits/${currentUser.id}`);
        
        // üé® Transformations (compression automatique)
        formData.append('quality', 'auto:good');
        formData.append('fetch_format', 'auto');
        
        // üì§ Upload vers Cloudinary
        const cloudinaryUrl = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
        
        console.log('üåê URL upload:', cloudinaryUrl);
        console.log('üì§ Envoi en cours...');
        
        const uploadResponse = await fetch(cloudinaryUrl, {
            method: 'POST',
            body: formData
        });
        
        console.log('üì• Statut r√©ponse:', uploadResponse.status);
        
        // ‚ùå Gestion des erreurs d√©taill√©e
        if (!uploadResponse.ok) {
            const errorText = await uploadResponse.text();
            console.error('‚ùå R√©ponse serveur:', errorText);
            
            let errorData;
            try {
                errorData = JSON.parse(errorText);
            } catch {
                throw new Error(`Erreur HTTP ${uploadResponse.status}: ${errorText}`);
            }
            
            // Messages d'erreur sp√©cifiques
            if (errorData.error?.message) {
                const errMsg = errorData.error.message;
                
                if (errMsg.includes('Invalid upload preset')) {
                    throw new Error('‚ùå Upload Preset invalide. V√©rifiez votre configuration Cloudinary.');
                }
                if (errMsg.includes('Invalid cloud name')) {
                    throw new Error('‚ùå Cloud Name invalide. V√©rifiez votre configuration Cloudinary.');
                }
                if (errMsg.includes('File size too large')) {
                    throw new Error('‚ùå Fichier trop volumineux.');
                }
                
                throw new Error(`Cloudinary: ${errMsg}`);
            }
            
            throw new Error(`Erreur upload (${uploadResponse.status})`);
        }
        
        const result = await uploadResponse.json();
        const imageUrl = result.secure_url;
        
        console.log('‚úÖ Image upload√©e avec succ√®s:', imageUrl);
        console.log('üìä Infos:', {
            url: imageUrl,
            publicId: result.public_id,
            format: result.format,
            width: result.width,
            height: result.height,
            size: (result.bytes / 1024).toFixed(2) + ' KB'
        });
        
        return imageUrl;
        
    } catch (error) {
        console.error('‚ùå Erreur upload Cloudinary:', error);
        console.error('üìã D√©tails erreur:', {
            message: error.message,
            stack: error.stack
        });
        
        // Message d'erreur plus clair pour l'utilisateur
        if (error.message.includes('Upload Preset')) {
            throw new Error('Configuration Cloudinary incorrecte. Contactez l\'administrateur.');
        }
        if (error.message.includes('Cloud Name')) {
            throw new Error('Configuration Cloudinary incorrecte. Contactez l\'administrateur.');
        }
        if (error.message.includes('Failed to fetch')) {
            throw new Error('Erreur de connexion. V√©rifiez votre connexion internet.');
        }
        
        throw new Error(`Upload √©chou√©: ${error.message}`);
    }
}
// ==================== üîß FONCTION DE TEST (√Ä RETIRER EN PRODUCTION) ====================


// ==================== FONCTIONS SUPABASE ====================
async function chargerProduits() {
    try {
        if (!currentUser) {
            console.warn('‚ö†Ô∏è Aucun utilisateur connect√©');
            return [];
        }
        
        const { data, error } = await supabase
            .from('produits')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) throw error;

        produits = data || [];
        console.log(`‚úÖ ${produits.length} produit(s) charg√©s`);
        
        return produits;
    } catch (error) {
        console.error('‚ùå Erreur chargement produits:', error);
        return [];
    }
}

async function sauvegarderProduit(produitData) {
    try {
        produitData.user_id = currentUser.id;
        
        const { data, error } = await supabase
            .from('produits')
            .insert([produitData])
            .select()
            .single();

        if (error) throw error;

        console.log('üíæ Produit sauvegard√©:', data);
        return data;
    } catch (error) {
        console.error('‚ùå Erreur sauvegarde:', error);
        throw error;
    }
}

async function mettreAJourProduit(id, produitData) {
    try {
        if (produitData.statut === 'published') {
            produitData.date_draft = null;
        } else if (produitData.statut === 'draft' && !produitData.date_draft) {
            produitData.date_draft = new Date().toISOString();
        }
        
        const { data, error } = await supabase
            .from('produits')
            .update(produitData)
            .eq('id', id)
            .eq('user_id', currentUser.id)
            .select()
            .single();

        if (error) throw error;

        console.log('‚úèÔ∏è Produit mis √† jour:', data);
        return data;
    } catch (error) {
        console.error('‚ùå Erreur mise √† jour:', error);
        throw error;
    }
}

async function chargerStatistiques() {
    try {
        if (!currentUser) return;
        
        const { data: produits } = await supabase
            .from('produits')
            .select('*')
            .eq('user_id', currentUser.id);
        
        const { data: commandes } = await supabase
            .from('commandes')
            .select('*')
            .eq('user_id', currentUser.id);
        
        const nbProduits = produits?.length || 0;
        const nbCommandes = commandes?.length || 0;
        
        let chiffreAffaires = 0;
        if (commandes && commandes.length > 0) {
            chiffreAffaires = commandes.reduce((total, cmd) => total + (cmd.montant || 0), 0);
        }
        
        const kpiCards = document.querySelectorAll('.kpi-card');
        if (kpiCards[0]) {
            const valueElem = kpiCards[0].querySelector('.kpi-value');
            if (valueElem) {
                valueElem.textContent = `${chiffreAffaires.toLocaleString('fr-FR')} FCFA`;
            }
        }
        
        if (kpiCards[1]) {
            const valueElem = kpiCards[1].querySelector('.kpi-value');
            if (valueElem) {
                valueElem.textContent = nbCommandes;
            }
        }
        
        if (kpiCards[2]) {
            const valueElem = kpiCards[2].querySelector('.kpi-value');
            if (valueElem) {
                valueElem.textContent = nbProduits;
            }
        }
        
    } catch (error) {
        console.error('‚ùå Erreur statistiques:', error);
    }
}

// ==================== üÜï GESTION SOUMISSION FORMULAIRE AVEC CLOUDINARY ====================
async function gererSoumissionFormulaire(e) {
    e.preventDefault();
    
    const btnSubmit = e.target.querySelector('button[type="submit"]');
    const textOriginal = btnSubmit.textContent;
    
    try {
        // üìÑ Afficher le chargement
        btnSubmit.disabled = true;
        btnSubmit.textContent = '‚è≥ Enregistrement...';
        
        // üìã R√©cup√©rer les donn√©es du formulaire
        const nom = document.getElementById('productName').value.trim();
        const description = document.getElementById('productDescription').value.trim();
        const prix = parseFloat(document.getElementById('productPrice').value);
        const stock = parseInt(document.getElementById('productStock').value);
        const categorie = document.getElementById('productCategory').value;
        const statutSelectionne = document.querySelector('input[name="productStatus"]:checked').value;
        
        // ‚úÖ Validation des champs obligatoires
        if (!nom || !description || !prix || !stock || !categorie) {
            afficherNotification('‚ùå Veuillez remplir tous les champs obligatoires', 'error');
            btnSubmit.disabled = false;
            btnSubmit.textContent = textOriginal;
            return;
        }
        
        if (!mainImage) {
            afficherNotification('‚ùå Veuillez ajouter une image principale', 'error');
            btnSubmit.disabled = false;
            btnSubmit.textContent = textOriginal;
            return;
        }
        
        // üìä V√âRIFIER LE QUOTA SI PUBLICATION
        let statutFinal = statutSelectionne;
        
        if (statutSelectionne === 'published') {
            console.log('üîç V√©rification du quota avant publication...');
            const quota = await verifierQuotaAvantPublication(produitEnEdition?.id);
            
            if (!quota.peutPublier) {
                console.warn(`‚ö†Ô∏è Quota atteint: ${quota.nombrePublies}/${quota.limite}`);
                
                afficherNotification(
                    `‚ùå Limite atteinte : ${quota.nombrePublies}/${quota.limite} produits publi√©s. ${quota.planActif ? 'Passez √† un plan sup√©rieur' : 'Activez un abonnement'} pour publier plus.`,
                    'error'
                );
                
                // ‚úÖ Proposer de sauvegarder en brouillon
                const confirmer = confirm(
                    `‚ö†Ô∏è Vous avez atteint la limite de ${quota.limite} produits publi√©s.\n\n` +
                    `Voulez-vous enregistrer ce produit en BROUILLON ?\n\n` +
                    `‚Üí OUI : Le produit sera sauvegard√© mais non visible\n` +
                    `‚Üí NON : Annuler l'enregistrement`
                );
                
                if (confirmer) {
                    statutFinal = 'draft';
                    document.querySelector('input[name="productStatus"][value="draft"]').checked = true;
                    afficherNotification('‚ÑπÔ∏è Le produit sera enregistr√© en brouillon', 'info');
                } else {
                    btnSubmit.disabled = false;
                    btnSubmit.textContent = textOriginal;
                    return;
                }
            } else {
                console.log(`‚úÖ Quota OK : ${quota.nombrePublies}/${quota.limite} (${quota.restant} restant${quota.restant > 1 ? 's' : ''})`);
            }
        }
        
        // üì§ üÜï UPLOAD DE L'IMAGE PRINCIPALE VERS CLOUDINARY
        btnSubmit.textContent = '‚è≥ Upload image principale...';
        let mainImageUrl;
        
        if (typeof mainImage === 'string') {
            // L'image existe d√©j√† (√©dition), garder l'URL
            mainImageUrl = mainImage;
            console.log('üìå Image principale existante conserv√©e');
        } else {
            // Nouvelle image, upload vers Cloudinary
            try {
                mainImageUrl = await uploaderImageVersCloudinary(mainImage, 'main');
                console.log('‚úÖ Image principale upload√©e:', mainImageUrl);
            } catch (uploadError) {
                console.error('‚ùå Erreur upload image principale:', uploadError);
                afficherNotification('‚ùå Erreur lors de l\'upload de l\'image principale', 'error');
                btnSubmit.disabled = false;
                btnSubmit.textContent = textOriginal;
                return;
            }
        }
        
        // üì§ üÜï UPLOAD DES IMAGES DE DESCRIPTION VERS CLOUDINARY
        btnSubmit.textContent = '‚è≥ Upload images description...';
        const descriptionImagesUrls = [];
        
        for (let i = 0; i < descriptionImages.length; i++) {
            const img = descriptionImages[i];
            if (img) {
                if (typeof img === 'string') {
                    // L'image existe d√©j√† (√©dition), garder l'URL
                    descriptionImagesUrls.push(img);
                    console.log(`üìå Image description ${i + 1} existante conserv√©e`);
                } else {
                    // Nouvelle image, upload vers Cloudinary
                    try {
                        const url = await uploaderImageVersCloudinary(img, `desc_${i + 1}`);
                        descriptionImagesUrls.push(url);
                        console.log(`‚úÖ Image description ${i + 1} upload√©e:`, url);
                    } catch (uploadError) {
                        console.error(`‚ùå Erreur upload image description ${i + 1}:`, uploadError);
                        // Continuer m√™me si une image description √©choue
                    }
                }
            }
        }
        
        // üóÇÔ∏è Construire l'objet produit
        const produitData = {
            nom,
            description,
            prix,
            stock,
            categorie,
            statut: statutFinal,
            main_image: mainImageUrl, // ‚úÖ URL Cloudinary au lieu de base64
            description_images: descriptionImagesUrls, // ‚úÖ URLs Cloudinary au lieu de base64
            date_draft: statutFinal === 'draft' ? new Date().toISOString() : null
        };
        
        // üíæ Sauvegarder ou mettre √† jour
        btnSubmit.textContent = '‚è≥ Sauvegarde...';
        
        if (produitEnEdition) {
            await mettreAJourProduit(produitEnEdition.id, produitData);
            afficherNotification('‚úÖ Produit mis √† jour avec succ√®s !', 'success');
        } else {
            await sauvegarderProduit(produitData);
            afficherNotification('‚úÖ Produit cr√©√© avec succ√®s !', 'success');
        }
        
        // üîÑ Recharger et r√©initialiser
        await chargerProduits();
        await chargerStatistiques();
        await afficherStatutAbonnement();
        reinitialiserFormulaire();
        
        // üéâ Redirection optionnelle
        setTimeout(() => {
            const confirmer = confirm('Produit enregistr√© ! Voulez-vous voir vos produits ?');
            if (confirmer) {
                window.location.href = 'produit.html';
            }
        }, 1000);
        
    } catch (error) {
        console.error('‚ùå Erreur lors de la soumission:', error);
        afficherNotification('‚ùå Erreur : ' + error.message, 'error');
    } finally {
        btnSubmit.disabled = false;
        btnSubmit.textContent = textOriginal;
    }
}
// ==================== UTILITAIRES ====================
function reinitialiserFormulaire() {
    document.getElementById('productForm').reset();
    descriptionImages = [null, null, null];
    mainImage = null;
    produitEnEdition = null;

    const preview = document.getElementById('mainImagePreview');
    const uploadZone = document.querySelector('.upload-zone');
    if (preview) preview.style.display = 'none';
    if (uploadZone) uploadZone.style.display = 'block';

    const slots = document.querySelectorAll('.description-image-slot');
    slots.forEach((slot, index) => {
        slot.classList.remove('has-image');
        slot.innerHTML = `
            <div class="description-image-placeholder">
                <div class="description-image-icon">üñºÔ∏è</div>
                <p style="font-size: 0.85rem;">Image ${index + 1}</p>
            </div>
            <input type="file" accept="image/*" style="display: none;" class="desc-image-input">
        `;
        const input = slot.querySelector('.desc-image-input');
        input.addEventListener('change', (e) => gererImageDescription(e, index));
    });

    mettreAJourApercu();
    mettreAJourApercuImages();
    mettreAJourApercuPrincipal();
    
    console.log('üîÑ Formulaire r√©initialis√©');
}

async function verifierEditionDepuisLocalStorage() {
    const idProduit = localStorage.getItem('produit_en_edition');
    
    if (idProduit) {
        console.log('üîç Chargement du produit pour √©dition:', idProduit);
        await chargerProduitPourEdition(parseInt(idProduit));
        localStorage.removeItem('produit_en_edition');
    }
}

async function chargerProduitPourEdition(id) {
    try {
        const { data, error } = await supabase
            .from('produits')
            .select('*')
            .eq('id', id)
            .eq('user_id', currentUser.id)
            .single();

        if (error) throw error;

        produitEnEdition = data;

        document.getElementById('productName').value = data.nom;
        document.getElementById('productDescription').value = data.description;
        document.getElementById('productPrice').value = data.prix;
        document.getElementById('productStock').value = data.stock;
        document.getElementById('productCategory').value = data.categorie;
        document.querySelector(`input[name="productStatus"][value="${data.statut}"]`).checked = true;

        // ‚úÖ Charger l'image principale (URL Cloudinary)
        if (data.main_image) {
            mainImage = data.main_image; // Stocker l'URL directement
            afficherImagePrincipale(data.main_image);
        }

        // ‚úÖ Charger les images de description (URLs Cloudinary)
        if (data.description_images && Array.isArray(data.description_images)) {
            data.description_images.forEach((url, index) => {
                if (index < 3) {
                    descriptionImages[index] = url; // Stocker les URLs directement
                    afficherImageDansSlot(index, url);
                }
            });
        }

        mettreAJourApercu();
        mettreAJourApercuImages();
        afficherNotification('‚úèÔ∏è Produit charg√© pour √©dition', 'info');
    } catch (error) {
        console.error('‚ùå Erreur chargement:', error);
        afficherNotification('‚ùå Erreur lors du chargement du produit', 'error');
    }
}

function afficherNotification(message, type = 'info') {
    let conteneur = document.getElementById('notification-container');

    if (!conteneur) {
        conteneur = document.createElement('div');
        conteneur.id = 'notification-container';
        conteneur.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        `;
        document.body.appendChild(conteneur);
    }

    const couleurs = {
        success: '#34C759',
        error: '#FF3B30',
        info: '#007AFF',
        warning: '#FF9500'
    };

    const notification = document.createElement('div');
    notification.style.cssText = `
        background: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-left: 4px solid ${couleurs[type]};
        animation: slideIn 0.5s ease;
        max-width: 350px;
        font-family: 'Poppins', sans-serif;
        font-weight: 500;
        color: #333;
    `;
    notification.textContent = message;

    conteneur.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'fadeOut 0.5s ease';
        setTimeout(() => notification.remove(), 500);
    }, 4000);
}

// ==================== ANIMATIONS CSS ====================
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
        to { opacity: 0; transform: translateY(-10px); }
    }
    @keyframes slideDown {
        from { transform: translate(-50%, -100px); opacity: 0; }
        to { transform: translate(-50%, 0); opacity: 1; }
    }
    @keyframes slideInRight {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
`;
document.head.appendChild(style);

// ==================== LOG D√âMARRAGE ====================
console.log('%cüå∏ Tableau de Bord - Ma Boutique √âl√©gante üå∏', 'color: #007AFF; font-size: 20px; font-weight: bold;');
console.log('%c‚úÖ Connect√© √† Supabase + Syst√®me d\'abonnement actif', 'color: #4CAF50; font-weight: bold;');
console.log('%cüîí Plan gratuit: 10 produits | Brouillons supprim√©s apr√®s 14 jours', 'color: #FF9500; font-weight: bold;');
console.log('%cüíæ V√©rification du quota avant chaque publication', 'color: #2196F3; font-size: 12px;');
console.log('%c‚òÅÔ∏è Upload s√©curis√© via Cloudinary avec compression automatique', 'color: #FF6B35; font-weight: bold;');

</script>
</html>