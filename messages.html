
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Ma Boutique ODA</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="oda.jpg">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<style>
    /* ==================== VARIABLES ==================== */
:root {
    --primary-color: #007AFF;
    --primary-hover: #0056b3;
    --secondary-color: #E8F4FF;
    --bg-general: #F5F5F7;
    --bg-card: #FFFFFF;
    --text-primary: #1D1D1F;
    --text-secondary: #86868B;
    --border-color: #D2D2D7;
    --success: #34C759;
    --error: #FF3B30;
    --gradient-primary: linear-gradient(135deg, #007AFF 0%, #5AC8FA 100%);
    --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.08);
    --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.12);
    --transition-fast: 0.3s ease;
    --header-height: 70px;
}

/* ==================== RESET ==================== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Poppins', sans-serif;
    background-color: var(--bg-general);
    color: var(--text-primary);
    line-height: 1.6;
    overflow: hidden;
    height: 100%;
    height: 100dvh; /* dvh = dynamic viewport height, tient compte du clavier */
    width: 100vw;
}

body.menu-open {
    overflow: hidden;
    position: fixed;
    width: 100%;
    height: 100vh;
}

/* ==================== ARRIÃˆRE-PLAN MOTIFS PRODUITS ODA ==================== */
.oda-pattern-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    background-color: #f5f5f7;
    background-image: 
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60' viewBox='0 0 60 60'%3E%3Cg opacity='0.12'%3E%3Crect x='20' y='15' width='20' height='30' rx='3' fill='%23007AFF' stroke='%23005BBB' stroke-width='1'/%3E%3Ccircle cx='30' cy='40' r='1.5' fill='%23fff'/%3E%3Crect x='24' y='18' width='12' height='1' rx='0.5' fill='%23fff' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E"),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='70' height='70' viewBox='0 0 70 70'%3E%3Cg opacity='0.11'%3E%3Cpath fill='%23FF6B00' d='M35 20L30 25L25 20L20 25L20 35L25 35L25 50L45 50L45 35L50 35L50 25L45 20L40 25Z'/%3E%3C/g%3E%3C/svg%3E"),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cg opacity='0.13'%3E%3Cpath fill='%231A1A1A' d='M25 45Q20 40 25 35L35 30L50 35Q55 40 50 45L45 48Q40 50 35 48Z M28 38L32 36L36 38'/%3E%3C/g%3E%3C/svg%3E"),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='90' height='90' viewBox='0 0 90 90'%3E%3Cg opacity='0.1'%3E%3Crect x='25' y='30' width='40' height='25' rx='2' fill='%23666'/%3E%3Crect x='28' y='33' width='34' height='19' fill='%2387CEEB'/%3E%3Cpath d='M20 55L25 55L25 30L65 30L65 55L70 55L68 58L22 58Z' fill='%23888'/%3E%3C/g%3E%3C/svg%3E"),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='65' height='65' viewBox='0 0 65 65'%3E%3Cg opacity='0.12'%3E%3Cpath fill='%23E91E63' d='M25 25Q23 20 25 15L40 15Q42 20 40 25L42 45L23 45Z M28 18Q28 15 32.5 15Q37 15 37 18'/%3E%3C/g%3E%3C/svg%3E"),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='55' height='55' viewBox='0 0 55 55'%3E%3Cg opacity='0.14'%3E%3Ccircle cx='27.5' cy='27.5' r='10' fill='none' stroke='%23FFD700' stroke-width='2'/%3E%3Crect x='25' y='17' width='5' height='3' rx='1' fill='%23666'/%3E%3Crect x='25' y='35' width='5' height='3' rx='1' fill='%23666'/%3E%3Cline x1='27.5' y1='27.5' x2='27.5' y2='22' stroke='%23333' stroke-width='1.5'/%3E%3Cline x1='27.5' y1='27.5' x2='32' y2='27.5' stroke='%23333' stroke-width='1'/%3E%3C/g%3E%3C/svg%3E");
    background-position: 
        0 0, 60px 30px, 20px 70px, 90px 10px, 130px 80px, 40px 120px;
    background-size: 
        60px 60px, 70px 70px, 80px 80px, 90px 90px, 65px 65px, 55px 55px;
    opacity: 0.3;
    animation: patternMove 80s linear infinite;
}

@keyframes patternMove {
    0% {
        background-position: 
            0 0, 60px 30px, 20px 70px, 90px 10px, 130px 80px, 40px 120px;
    }
    100% {
        background-position: 
            60px 60px, 120px 90px, 80px 130px, 150px 70px, 190px 140px, 100px 180px;
    }
}

/* ==================== ANIMATIONS ==================== */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideDown {
    from { opacity: 0; transform: translateY(-30px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* ==================== HEADER ==================== */
.main-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    box-shadow: var(--shadow-light);
    z-index: 1000;
    animation: slideDown var(--transition-fast);
}

.header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 24px;
    max-width: 1920px;
    margin: 0 auto;
    height: 100%;
}

.brand-section {
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo-image {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.brand-name {
    font-size: 1.4rem;
    font-weight: 600;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 16px;
}

.connection-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    padding: 8px 16px;
    border-radius: 20px;
    background: rgba(76, 175, 80, 0.1);
    color: #4CAF50;
}

.connection-status.disconnected {
    background: rgba(244, 67, 54, 0.1);
    color: #f44336;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    animation: pulse 2s infinite;
}

.icon-btn {
    position: relative;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 8px;
}

.notification-btn .badge {
    position: absolute;
    top: 5px;
    right: 5px;
    background: #FF3B30;
    color: white;
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 600;
}

.user-profile {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 16px;
    border-radius: 50px;
    background: var(--secondary-color);
    cursor: pointer;
}

.avatar-image {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background: var(--gradient-primary);
    border: 2px solid var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
}

.user-name {
    font-weight: 500;
    color: var(--text-primary);
}

/* ==================== MENU HAMBURGER ==================== */
.hamburger-btn {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    width: 32px;
    height: 32px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 4px;
    z-index: 10001;
    transition: var(--transition-fast);
}

.hamburger-btn span {
    display: block;
    width: 100%;
    height: 3px;
    background: var(--primary-color);
    border-radius: 10px;
    transition: var(--transition-fast);
}

.hamburger-btn.active span:nth-child(1) {
    transform: rotate(45deg) translate(8px, 8px);
}

.hamburger-btn.active span:nth-child(2) {
    opacity: 0;
}

.hamburger-btn.active span:nth-child(3) {
    transform: rotate(-45deg) translate(7px, -7px);
}

.hamburger-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 9998;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none;
}

.hamburger-overlay.active {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
}

.hamburger-menu {
    position: fixed;
    top: 0;
    left: -100%;
    width: 280px;
    height: 100vh;
    background: white;
    box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow-y: auto;
}

.hamburger-menu.active {
    left: 0;
}

.hamburger-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px;
    border-bottom: 1px solid #f0f0f0;
    background: linear-gradient(135deg, #007AFF 0%, #5AC8FA 100%);
    color: white;
}

.hamburger-header .logo-image {
    width: 40px;
    height: 40px;
    background: white;
    border-radius: 10px;
}

.hamburger-header .brand-name {
    font-size: 1.3rem;
    font-weight: 700;
    color: white;
    -webkit-text-fill-color: white;
}

.close-menu {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.close-menu:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: rotate(90deg);
}

.hamburger-nav {
    flex: 1;
    padding: 20px 0;
    overflow-y: auto;
}

.hamburger-link {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 14px 20px;
    color: #333;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    border: none;
    background: transparent;
    width: 100%;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
}

.hamburger-link:hover {
    background: #f8f9fa;
    color: var(--primary-color);
    padding-left: 25px;
}

.hamburger-link.active {
    background: linear-gradient(90deg, rgba(0, 122, 255, 0.1) 0%, transparent 100%);
    color: var(--primary-color);
    border-left: 4px solid var(--primary-color);
    font-weight: 600;
}

.link-icon {
    font-size: 1.3rem;
    min-width: 24px;
    text-align: center;
}

.hamburger-divider {
    height: 1px;
    background: #e0e0e0;
    margin: 15px 20px;
}

.hamburger-footer {
    padding: 15px 20px;
    border-top: 1px solid #f0f0f0;
    background: #fafafa;
}

.hamburger-footer .hamburger-link {
    padding: 12px 15px;
    border-radius: 8px;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

/* ==================== MESSAGES CONTAINER - PLEIN Ã‰CRAN ==================== */
.messages-container {
    position: fixed;
    top: var(--header-height);
    left: 0;
    right: 0;
    bottom: 0;
    display: grid;
    grid-template-columns: 380px 1fr;
    gap: 0;
    max-width: 100vw;
    margin: 0;
    padding: 0;
    height: calc(100vh - var(--header-height));
    height: calc(100dvh - var(--header-height)); /* fallback + dvh */
    overflow: hidden;
}

/* ==================== SIDEBAR - PLEINE HAUTEUR ==================== */
.messages-sidebar {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    border-right: 1px solid rgba(0, 122, 255, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.sidebar-header {
    padding: 20px;
    border-bottom: 2px solid var(--bg-general);
    background: rgba(232, 244, 255, 0.5);
    flex-shrink: 0;
}

.sidebar-title {
    font-size: 1.3rem;
    color: var(--primary-color);
    margin-bottom: 16px;
    font-weight: 700;
}

.search-box {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid rgba(0, 122, 255, 0.2);
    border-radius: 12px;
    font-family: 'Poppins', sans-serif;
    font-size: 0.9rem;
    transition: var(--transition-fast);
}

.search-box:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
}

.filter-buttons {
    display: flex;
    gap: 8px;
    margin: 12px 0;
}

.filter-btn {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid rgba(0, 122, 255, 0.3);
    border-radius: 20px;
    background: white;
    color: var(--text-secondary);
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition-fast);
    font-family: 'Poppins', sans-serif;
}

.filter-btn.active {
    background: var(--gradient-primary);
    color: white;
    border-color: transparent;
}

.messages-count {
    font-size: 0.85rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.messages-list {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
}

.message-item {
    padding: 16px 20px;
    border-bottom: 1px solid rgba(0, 122, 255, 0.1);
    cursor: pointer;
    transition: var(--transition-fast);
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.message-item:hover {
    background: rgba(0, 122, 255, 0.05);
}

.message-item.active {
    background: rgba(0, 122, 255, 0.12);
    border-left: 4px solid var(--primary-color);
}

.message-item.unread {
    background: rgba(0, 122, 255, 0.08);
}

.message-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    flex-shrink: 0;
}

.message-content {
    flex: 1;
    min-width: 0;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
}

.message-name {
    font-weight: 600;
    color: var(--text-primary);
}

.message-time {
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.message-preview {
    font-size: 0.9rem;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.unread-badge {
    background: var(--primary-color);
    color: white;
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: 8px;
}

/* ==================== CONVERSATION PANEL - PLEIN Ã‰CRAN ==================== */
.conversation-panel {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(10px);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    height: 100%;
}

.conversation-header {
    padding: 20px 24px;
    border-bottom: 2px solid var(--bg-general);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
    background: rgba(232, 244, 255, 0.5);
    min-height: 90px;
}

.conversation-info {
    display: flex;
    gap: 12px;
    align-items: center;
}

.conversation-avatar {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 1.3rem;
}

.conversation-details h3 {
    font-size: 1.2rem;
    margin-bottom: 4px;
}

.conversation-status {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.conversation-actions {
    display: flex;
    gap: 8px;
}

.action-btn {
    padding: 10px 16px;
    border: none;
    border-radius: 10px;
    background: rgba(0, 122, 255, 0.1);
    color: var(--primary-color);
    cursor: pointer;
    transition: var(--transition-fast);
    font-size: 0.9rem;
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
}

.action-btn:hover {
    background: rgba(0, 122, 255, 0.2);
    transform: translateY(-2px);
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    background: #FAFAFA;
}

.chat-message {
    display: flex;
    gap: 12px;
    max-width: 70%;
    animation: slideUp 0.3s ease;
}

.chat-message.sent {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.chat-message.received {
    align-self: flex-start;
}

.chat-message-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: var(--gradient-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.chat-message-content {
    background: white;
    padding: 12px 16px;
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.chat-message.sent .chat-message-content {
    background: var(--gradient-primary);
    color: white;
}

.chat-message-text {
    margin-bottom: 4px;
    word-wrap: break-word;
}

.chat-message-time {
    font-size: 0.75rem;
    opacity: 0.7;
}

.chat-input-container {
    padding: 20px 24px;
    border-top: 2px solid var(--bg-general);
    background: white;
    flex-shrink: 0;
}

.chat-input-wrapper {
    display: flex;
    gap: 12px;
    align-items: flex-end;
}

.chat-input {
    flex: 1;
    padding: 14px 18px;
    border: 2px solid rgba(0, 122, 255, 0.2);
    border-radius: 12px;
    font-family: 'Poppins', sans-serif;
    font-size: 0.95rem;
    resize: none;
    transition: var(--transition-fast);
    max-height: 120px;
    min-height: 48px;
}

.chat-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
}

.send-btn {
    padding: 14px 28px;
    background: var(--gradient-primary);
    color: white;
    border: none;
    border-radius: 12px;
    font-family: 'Poppins', sans-serif;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-fast);
    font-size: 0.95rem;
}

.send-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-medium);
}

.send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.empty-conversation {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-secondary);
}

.empty-icon {
    font-size: 5rem;
    margin-bottom: 20px;
    opacity: 0.5;
}

.mobile-back-btn {
    display: none;
    align-items: center;
    gap: 8px;
    background: none;
    border: none;
    color: var(--primary-color);
    font-size: 1rem;
    font-weight: 600;
    padding: 8px;
    cursor: pointer;
    font-family: 'Poppins', sans-serif;
}

/* ==================== SCROLLBARS ==================== */
.messages-list::-webkit-scrollbar,
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.messages-list::-webkit-scrollbar-track,
.chat-messages::-webkit-scrollbar-track {
    background: rgba(0, 122, 255, 0.05);
    border-radius: 10px;
}

.messages-list::-webkit-scrollbar-thumb,
.chat-messages::-webkit-scrollbar-thumb {
    background: rgba(0, 122, 255, 0.2);
    border-radius: 10px;
}

.messages-list::-webkit-scrollbar-thumb:hover,
.chat-messages::-webkit-scrollbar-thumb:hover {
    background: rgba(0, 122, 255, 0.3);
}

/* ==================== RESPONSIVE ==================== */
@media (max-width: 768px) {
    .header-container {
        padding: 12px 16px;
    }

    .brand-name {
        font-size: 1.1rem;
    }

    .user-name {
        display: none;
    }

    .connection-status {
        display: none;
    }

    .messages-container {
        grid-template-columns: 1fr;
        top: var(--header-height);
    }

    .messages-sidebar {
        border-radius: 0;
        border-right: none;
    }

    .messages-sidebar.mobile-hidden {
        display: none;
    }

    .conversation-panel {
        display: none;
    }

    .conversation-panel.mobile-show {
        display: flex;
    }

    .mobile-back-btn {
        display: flex;
    }

    .hamburger-menu {
        width: 75vw;
        max-width: 300px;
    }

    .chat-message {
        max-width: 85%;
    }
}

@media (max-width: 480px) {
    .brand-section .brand-name {
        font-size: 0.9rem;
    }

    .logo-image {
        width: 35px;
        height: 35px;
        font-size: 1.2rem;
    }

    .hamburger-menu {
        width: 80vw;
        max-width: 320px;
    }

    .sidebar-header {
        padding: 16px;
    }

    .chat-input-container {
        padding: 16px;
    }

    .conversation-header {
        padding: 16px;
        min-height: 80px;
    }
}
@media (max-width: 768px) {
    .conversation-panel.mobile-show {
        position: fixed;
        top: var(--header-height);
        left: 0;
        right: 0;
        bottom: 0;
        height: calc(100dvh - var(--header-height));
        display: flex;
        flex-direction: column;
    }

    .chat-input-container {
        position: sticky;
        bottom: 0;
        z-index: 10;
        background: white;
    }
}
</style>
<body>
    <!-- ArriÃ¨re-plan avec motifs de produits ODA -->
    <div class="oda-pattern-background"></div>

    <!-- Menu Hamburger Overlay -->
    <div class="hamburger-overlay" id="hamburgerOverlay"></div>
    
    <!-- Menu Hamburger -->
    <div class="hamburger-menu" id="hamburgerMenu">
        <div class="hamburger-header">
            <div class="brand-section">
                <div class="logo-image">ğŸ’¬</div>
                <h1 class="brand-name">ODA</h1>
            </div>
            <button class="close-menu" id="closeMenu">
                <span>Ã—</span>
            </button>
        </div>
        
        <nav class="hamburger-nav">
            <a href="tableau.html" class="hamburger-link">
                <span class="link-icon">ğŸ“Š</span>
                <span>Tableau de bord</span>
            </a>
            <a href="produits.html" class="hamburger-link">
                <span class="link-icon">ğŸ“¦</span>
                <span>Produits</span>
            </a>
            <a href="commandes.html" class="hamburger-link">
                <span class="link-icon">ğŸ“‹</span>
                <span>Commandes</span>
            </a>
            <a href="clients.html" class="hamburger-link">
                <span class="link-icon">ğŸ‘¥</span>
                <span>Clients</span>
            </a>
            <a href="messages.html" class="hamburger-link active">
                <span class="link-icon">ğŸ’¬</span>
                <span>Messages</span>
            </a>
            
            <div class="hamburger-divider"></div>
            
            <a href="statitique.html" class="hamburger-link">
                <span class="link-icon">ğŸ“ˆ</span>
                <span>Statistiques</span>
            </a>
            <a href="parametres.html" class="hamburger-link">
                <span class="link-icon">âš™ï¸</span>
                <span>ParamÃ¨tres</span>
            </a>
            <a href="boutique.html" class="hamburger-link">
                <span class="link-icon">ğŸª</span>
                <span>Voir ma boutique</span>
            </a>
        </nav>
        
        <div class="hamburger-footer">
            <a href="https://whatsapp.com/channel/0029Vb6mcUm5q08htMMdVA2v" class="hamburger-link" target="_blank">
                <span class="link-icon">ğŸ“¢</span>
                <span>Notre chaÃ®ne WhatsApp</span>
            </a>
            <a href="https://t.me/+hqymnTrseaU2OWRk" class="hamburger-link" target="_blank">
                <span class="link-icon">âœˆï¸</span>
                <span>Notre groupe Telegram</span>
            </a>
        </div>
    </div>

    <!-- Header -->
    <header class="main-header">
        <div class="header-container">
            <button class="hamburger-btn" id="hamburgerBtn" aria-label="Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>

            <div class="header-actions">
                <div class="connection-status" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span id="statusText">Connexion...</span>
                </div>
                <button class="icon-btn notification-btn">
                    <span>ğŸ””</span>
                    <span class="badge" id="unreadBadge">0</span>
                </button>
                <div class="user-profile">
                    <div class="avatar-image">ğŸ‘¤</div>
                    <span class="user-name">Admin</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Container principal -->
    <div class="messages-container">
        <!-- Sidebar -->
        <aside class="messages-sidebar">
            <div class="sidebar-header">
                <h2 class="sidebar-title">Conversations</h2>
                <div class="search-box-container">
                    <input type="text" class="search-box" id="searchMessages" placeholder="ğŸ” Rechercher...">
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">Tous</button>
                    <button class="filter-btn" data-filter="unread">Non lus</button>
                </div>
                <div class="messages-count">
                    <span id="unreadCount">0</span> non lu(s)
                </div>
            </div>
            
            <div class="messages-list" id="messagesListContent">
                <!-- Messages gÃ©nÃ©rÃ©s dynamiquement -->
            </div>
        </aside>

        <!-- Panel de conversation -->
        <main class="conversation-panel" id="conversationPanel">
            <div class="empty-conversation">
                <div class="empty-icon">ğŸ’¬</div>
                <h3>SÃ©lectionnez une conversation</h3>
                <p>Choisissez un message dans la liste pour commencer</p>
            </div>
        </main>
    </div>
    <script src="cache-manager.js"></script>
<script src="message-notifications.js"></script>
<script type="module">
// ==================== CONFIGURATION SUPABASE ====================
const SUPABASE_URL      = 'https://xjckbqbqxcwzcrlmuvzf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhqY2ticWJxeGN3emNybG11dnpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTk1MzMsImV4cCI6MjA3NjA5NTUzM30.AMzAUwtjFt7Rvof5r2enMyYIYToc1wNWWEjvZqK_YXM';

// âœ… FIX : window.supabase depuis le CDN (pas de type="module" â†’ scope global)
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ==================== VARIABLES GLOBALES ====================
let conversations       = new Map();
let conversationActive  = null;
let pollingInterval     = null;
let currentUser         = null;
let notificationChecker = null;

// ==================== EMOJI POOL ====================
const EMOJI_POOL = {
    personnes:  ['ğŸ‘¨','ğŸ‘©','ğŸ§‘','ğŸ‘´','ğŸ‘µ','ğŸ‘¶','ğŸ§’','ğŸ‘¦','ğŸ‘§','ğŸ§”','ğŸ‘¨â€ğŸ’¼','ğŸ‘©â€ğŸ’¼','ğŸ§‘â€ğŸ’¼','ğŸ‘¨â€ğŸ“','ğŸ‘©â€ğŸ“'],
    emotions:   ['ğŸ˜Š','ğŸ˜','ğŸ¤—','ğŸ˜‡','ğŸ¥³','ğŸ¤©','ğŸ˜º','ğŸ±','ğŸ¦','ğŸ¯','ğŸ¦Š','ğŸ»','ğŸ¨','ğŸ¼','ğŸ¸'],
    objets:     ['ğŸ’¼','ğŸ¯','ğŸ¨','ğŸª','ğŸ­','ğŸ¬','ğŸ¸','ğŸ¹','ğŸº','ğŸ»','ğŸ†','ğŸ…','âš½','ğŸ€','ğŸ®'],
    nature:     ['ğŸŒŸ','â­','ğŸŒˆ','ğŸŒº','ğŸŒ¸','ğŸŒ¼','ğŸŒ»','ğŸŒ·','ğŸŒ¹','ğŸ€','ğŸŒ¿','ğŸŒ²','ğŸŒ´','ğŸŒµ','ğŸª´'],
    nourriture: ['ğŸ•','ğŸ”','ğŸ°','ğŸ‚','ğŸª','ğŸ©','ğŸ§','ğŸ¦','ğŸ§','ğŸ¨','ğŸ¥¤','â˜•','ğŸ“','ğŸ‡','ğŸ‰'],
    sports:     ['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¾','ğŸ','ğŸ“','ğŸ¸','ğŸ¥Š','ğŸ±','ğŸŠ','ğŸš´','â›·ï¸','ğŸ„','ğŸ¤¸']
};

// Tableau aplati calculÃ© une seule fois
const TOUS_LES_EMOJIS = Object.values(EMOJI_POOL).flat();

const COULEURS_AVATAR = [
    'linear-gradient(135deg,#667eea,#764ba2)',
    'linear-gradient(135deg,#f093fb,#f5576c)',
    'linear-gradient(135deg,#4facfe,#00f2fe)',
    'linear-gradient(135deg,#43e97b,#38f9d7)',
    'linear-gradient(135deg,#fa709a,#fee140)',
    'linear-gradient(135deg,#30cfd0,#330867)',
    'linear-gradient(135deg,#a8edea,#fed6e3)',
    'linear-gradient(135deg,#ff9a56,#ff6a88)',
    'linear-gradient(135deg,#ffecd2,#fcb69f)',
    'linear-gradient(135deg,#ff6e7f,#bfe9ff)',
    'linear-gradient(135deg,#e0c3fc,#8ec5fc)',
    'linear-gradient(135deg,#f77062,#fe5196)',
    'linear-gradient(135deg,#fccb90,#d57eeb)',
    'linear-gradient(135deg,#e2b0ff,#9f44d3)',
    'linear-gradient(135deg,#ffeaa7,#fd79a8)',
    'linear-gradient(135deg,#74ebd5,#acb6e5)',
    'linear-gradient(135deg,#ffd89b,#19547b)',
    'linear-gradient(135deg,#84fab0,#8fd3f4)',
    'linear-gradient(135deg,#a1c4fd,#c2e9fb)',
    'linear-gradient(135deg,#fd79a8,#fdcbf1)'
];

// ==================== UTILITAIRES AVATAR EMOJI ====================
function stringToHash(str) {
    if (!str) return 0;
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0;
    }
    return Math.abs(hash);
}

function getEmojiPourClient(clientName)  { return TOUS_LES_EMOJIS[stringToHash(clientName) % TOUS_LES_EMOJIS.length]; }
function getCouleurPourClient(clientName){ return COULEURS_AVATAR[stringToHash(clientName)  % COULEURS_AVATAR.length]; }
function genererAvatarClient(clientName) {
    return { emoji: getEmojiPourClient(clientName), couleur: getCouleurPourClient(clientName) };
}

// ==================== STYLES CSS INJECTÃ‰S ====================
function ajouterStylesProduitsMessages() {
    if (document.getElementById('products-messages-styles')) return;
    const style = document.createElement('style');
    style.id = 'products-messages-styles';
    style.textContent = `
        /* ---- Carte produit ---- */
        .message-product-card {
            max-width:280px; background:white; border-radius:16px;
            overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,.1);
            margin-bottom:8px; animation:fadeIn .4s ease;
            border:2px solid rgba(0,122,255,.1);
            transition:transform .2s ease, box-shadow .2s ease;
        }
        .message-product-card:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.15); }
        .message-product-card.sent  { border-color:rgba(0,122,255,.3); }
        .product-card-image { width:100%; height:180px; object-fit:cover; display:block; }
        .product-card-info  { padding:12px; }
        .product-card-name  { font-weight:600; font-size:.95rem; color:var(--text-primary); margin-bottom:8px; line-height:1.3; }
        .product-card-price { font-weight:700; font-size:1.1rem; color:var(--primary-color); margin-bottom:6px; }
        .product-card-stock { font-size:.8rem; color:var(--text-secondary); display:flex; align-items:center; gap:4px; }
        .product-badge {
            display:inline-flex; align-items:center; gap:6px;
            padding:4px 10px; background:rgba(0,122,255,.1);
            border-radius:12px; font-size:.75rem; color:var(--primary-color);
            font-weight:600; margin-top:6px;
        }

        /* ---- Groupes de messages ---- */
        .message-group { display:flex; flex-direction:column; gap:8px; margin-bottom:16px; }
        .message-group.sent     { align-items:flex-end; }
        .message-group.received { align-items:flex-start; }

        /* ---- Bulles ---- */
        .message-bubble {
            max-width:70%; padding:12px 16px; border-radius:16px;
            word-wrap:break-word; animation:messageSlideIn .3s ease;
        }
        .message-bubble.sent {
            background:linear-gradient(135deg,#007AFF,#5AC8FA);
            color:white; border-bottom-right-radius:4px;
        }
        .message-bubble.received {
            background:white; color:var(--text-primary);
            border-bottom-left-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,.08);
        }
        .message-text { margin-bottom:4px; line-height:1.4; }
        .message-time { font-size:.7rem; opacity:.7; display:flex; align-items:center; gap:4px; justify-content:flex-end; }
        .message-date { text-align:center; font-size:.8rem; color:var(--text-secondary); padding:12px 0; font-weight:500; }

        /* ---- Avatars emoji ---- */
        .message-avatar {
            width:48px; height:48px; border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            flex-shrink:0; font-size:1.6rem;
            box-shadow:0 2px 8px rgba(0,0,0,.15);
            transition:transform .3s ease, box-shadow .3s ease;
        }
        .message-item:hover .message-avatar { transform:scale(1.1); box-shadow:0 4px 12px rgba(0,0,0,.25); }
        .emoji-avatar { font-size:1.5rem; line-height:1; filter:drop-shadow(0 1px 2px rgba(0,0,0,.1)); }
        .conversation-avatar {
            width:46px; height:46px; border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            font-size:1.6rem; box-shadow:0 3px 10px rgba(0,0,0,.2); flex-shrink:0;
        }

        /* ---- Zone chat ---- */
        .chat-messages { flex:1; overflow-y:auto; padding:16px 8px; }
        .chat-input-container {
            padding:16px 24px; border-top:1px solid rgba(0,122,255,.1);
            background:rgba(255,255,255,.98);
        }
        .chat-input-wrapper { display:flex; gap:12px; align-items:flex-end; }
        .chat-input {
            flex:1; padding:12px 16px; border:2px solid rgba(0,122,255,.2);
            border-radius:12px; font-family:'Poppins',sans-serif; font-size:.9rem;
            resize:none; max-height:120px; overflow-y:auto; transition:border-color .3s;
            background:white;
        }
        .chat-input:focus { outline:none; border-color:var(--primary-color); box-shadow:0 0 0 3px rgba(0,122,255,.12); }
        .send-btn {
            padding:12px 24px; background:var(--gradient-primary);
            color:white; border:none; border-radius:12px; font-weight:600;
            cursor:pointer; font-family:'Poppins',sans-serif; white-space:nowrap;
            transition:opacity .2s, transform .2s; flex-shrink:0;
        }
        .send-btn:hover   { opacity:.9; transform:translateY(-1px); }
        .send-btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; }

        /* ---- Header conversation ---- */
        .conversation-header {
            display:flex; align-items:center; gap:12px; padding:16px 24px;
            border-bottom:1px solid rgba(0,122,255,.1); background:rgba(255,255,255,.98); min-height:80px;
        }
        .conversation-info   { display:flex; align-items:center; gap:12px; flex:1; min-width:0; }
        .conversation-details h3 { font-size:1.05rem; font-weight:600; margin:0 0 2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .conversation-status { font-size:.8rem; color:var(--text-secondary); }
        .conversation-actions { display:flex; gap:8px; flex-shrink:0; }
        .action-btn {
            padding:8px 14px; border-radius:10px; border:none; cursor:pointer;
            background:rgba(255,59,48,.1); color:#FF3B30; font-weight:500;
            font-family:'Poppins',sans-serif; transition:background .2s;
        }
        .action-btn:hover { background:rgba(255,59,48,.2); }

        /* ---- Vide ---- */
        .empty-conversation {
            display:flex; flex-direction:column; align-items:center;
            justify-content:center; height:100%; color:var(--text-secondary);
            text-align:center; gap:12px;
        }
        .empty-icon { font-size:4rem; opacity:.4; }

        /* ---- Mobile ---- */
        .mobile-back-btn {
            display:none; padding:8px 12px; border:none; background:none;
            cursor:pointer; font-size:.9rem; color:var(--primary-color);
            font-family:'Poppins',sans-serif; font-weight:500;
        }
        @media (max-width:768px) {
            .mobile-back-btn { display:flex; align-items:center; gap:6px; }
        }

        /* ---- Animations ---- */
        @keyframes fadeIn         { from{opacity:0;transform:translateY(10px)}  to{opacity:1;transform:translateY(0)} }
        @keyframes messageSlideIn { from{opacity:0;transform:translateY(15px)} to{opacity:1;transform:translateY(0)} }
        @keyframes fadeInConv     { from{opacity:0;transform:translateX(-20px)} to{opacity:1;transform:translateX(0)} }
        @keyframes slideLeft      { from{transform:translateX(400px);opacity:0} to{transform:translateX(0);opacity:1} }
        @keyframes fadeOut        { to{opacity:0;transform:translateY(-10px)} }

        .message-item { animation:fadeInConv .35s ease; }
        .message-item.active {
            background:linear-gradient(135deg,rgba(0,122,255,.08),rgba(90,200,250,.08));
            border-left:4px solid #007AFF;
        }
        .message-item.active .message-avatar { box-shadow:0 4px 16px rgba(0,122,255,.4); }
        .unread-badge {
            background:linear-gradient(135deg,#FF3B30,#FF6B60); color:white;
            font-size:.72rem; font-weight:600; padding:3px 8px; border-radius:12px;
            min-width:20px; text-align:center; box-shadow:0 2px 6px rgba(255,59,48,.3); margin-left:6px;
        }
        @keyframes slideInRight { from{transform:translateX(400px);opacity:0} to{transform:translateX(0);opacity:1} }
    `;
    document.head.appendChild(style);
}

// ==================== INITIALISATION ====================
// âœ… FIX : robuste contre le DOMContentLoaded dÃ©jÃ  passÃ©
async function init() {
    console.log('ğŸ’¬ Page Messages initialisÃ©e !');

    ajouterStylesProduitsMessages();
    await verifierAuthentification();

    if (!currentUser) return;

    initialiserMenuHamburger();
    await verifierConnexion();
    await chargerConversations();

    initialiserRecherche();
    initialiserFiltres();
    initialiserTextareaAutoResize();
    initialiserGestionClavierMobile(); // âœ… FIX CLAVIER MOBILE

    // âœ… FIX : initMessageNotifications vient de message-notifications.js (script global)
    //         On vÃ©rifie qu'elle est disponible avant de l'appeler
    if (typeof initMessageNotifications === 'function') {
        notificationChecker = await initMessageNotifications(supabase, currentUser);
        if (notificationChecker) console.log('ğŸ”” SystÃ¨me de notifications activÃ©');
    } else {
        console.warn('âš ï¸ initMessageNotifications non disponible');
    }

    demarrerPolling();
    console.log('âœ… Page messages prÃªte !');
}

// âœ… FIX : dÃ©clenche init() mÃªme si DOMContentLoaded est dÃ©jÃ  passÃ©
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}

// ==================== AUTHENTIFICATION ====================
async function verifierAuthentification() {
    try {
        const { data: { session }, error } = await supabase.auth.getSession();
        if (error) throw error;

        if (!session) {
            console.warn('âš ï¸ Aucune session active');
            afficherNotification('âš ï¸ Veuillez vous connecter', 'warning');
            setTimeout(() => { window.location.href = 'index.html'; }, 2000);
            return;
        }

        currentUser = session.user;
        console.log('âœ… Utilisateur connectÃ©:', currentUser.email);

        const el = document.querySelector('.user-name');
        if (el) el.textContent = currentUser.email.split('@')[0];

    } catch (err) {
        console.error('âŒ Erreur authentification:', err);
        afficherNotification('âŒ Erreur d\'authentification', 'error');
    }
}

// ==================== CONNEXION SUPABASE ====================
async function verifierConnexion() {
    const statusEl   = document.getElementById('connectionStatus');
    const statusText = document.getElementById('statusText');

    try {
        const { error } = await supabase.from('conversations').select('count').limit(1);
        if (error) throw error;

        statusEl?.classList.remove('disconnected');
        if (statusText) statusText.textContent = 'ConnectÃ©';
        console.log('âœ… Connexion Supabase OK');
    } catch (err) {
        console.error('âŒ Erreur connexion:', err);
        statusEl?.classList.add('disconnected');
        if (statusText) statusText.textContent = 'DÃ©connectÃ©';
        afficherNotification('âš ï¸ Connexion limitÃ©e', 'warning');
    }
}

// ==================== MENU HAMBURGER ====================
function initialiserMenuHamburger() {
    const hamburgerBtn     = document.getElementById('hamburgerBtn');
    const hamburgerMenu    = document.getElementById('hamburgerMenu');
    const hamburgerOverlay = document.getElementById('hamburgerOverlay');
    const closeMenuBtn     = document.getElementById('closeMenu');

    if (!hamburgerBtn || !hamburgerMenu || !hamburgerOverlay) {
        console.error('âŒ Ã‰lÃ©ments du menu manquants');
        return;
    }

    const ouvrirMenu = (e) => {
        e?.preventDefault(); e?.stopPropagation();
        hamburgerBtn.classList.add('active');
        hamburgerMenu.classList.add('active');
        hamburgerOverlay.classList.add('active');
        document.body.classList.add('menu-open');
    };

    const fermerMenu = (e) => {
        e?.preventDefault(); e?.stopPropagation();
        hamburgerBtn.classList.remove('active');
        hamburgerMenu.classList.remove('active');
        hamburgerOverlay.classList.remove('active');
        document.body.classList.remove('menu-open');
    };

    const toggleMenu = (e) => {
        hamburgerMenu.classList.contains('active') ? fermerMenu(e) : ouvrirMenu(e);
    };

    hamburgerBtn.addEventListener('touchstart', toggleMenu, { passive: false });
    hamburgerBtn.addEventListener('click', toggleMenu);
    closeMenuBtn?.addEventListener('touchstart', fermerMenu, { passive: false });
    closeMenuBtn?.addEventListener('click', fermerMenu);
    hamburgerOverlay.addEventListener('touchstart', fermerMenu, { passive: false });
    hamburgerOverlay.addEventListener('click', fermerMenu);

    document.querySelectorAll('.hamburger-link').forEach(link => {
        link.addEventListener('click', () => setTimeout(fermerMenu, 200));
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && hamburgerMenu.classList.contains('active')) fermerMenu();
    });

    console.log('âœ… Menu hamburger initialisÃ©');
}

// ==================== CHARGEMENT CONVERSATIONS ====================
async function chargerConversations() {
    if (!currentUser) {
        console.warn('âš ï¸ Aucun utilisateur connectÃ©');
        afficherConversationsVides();
        return;
    }

    try {
        const { data, error } = await supabase
            .from('conversations')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: true });

        if (error) throw error;

        conversations.clear();

        if (!data || data.length === 0) {
            afficherConversationsVides();
            return;
        }

        data.forEach(msg => {
            if (!conversations.has(msg.client_name)) conversations.set(msg.client_name, []);
            conversations.get(msg.client_name).push(msg);
        });

        afficherListeConversations();
        console.log(`âœ… ${conversations.size} conversation(s) chargÃ©e(s)`);

    } catch (err) {
        console.error('âŒ Erreur chargement:', err);
        afficherNotification('âŒ Erreur de chargement', 'error');
        afficherConversationsVides();
    }
}

// ==================== AFFICHAGE VIDE ====================
function afficherConversationsVides() {
    const container = document.getElementById('messagesListContent');
    if (!container) return;

    container.innerHTML = `
        <div style="padding:48px 24px;text-align:center;color:var(--text-secondary)">
            <div style="font-size:4rem;margin-bottom:16px;opacity:.5">ğŸ”­</div>
            <h3 style="font-size:1.1rem;margin-bottom:8px;color:var(--text-primary)">Aucune conversation</h3>
            <p style="font-size:.9rem;line-height:1.6">Les messages de vos clients apparaÃ®tront ici.</p>
        </div>`;

    const el    = document.getElementById('unreadCount');
    const badge = document.getElementById('unreadBadge');
    if (el)    el.textContent = '0';
    if (badge) badge.style.display = 'none';
}

// ==================== LISTE CONVERSATIONS ====================
function afficherListeConversations(filtre = 'all', recherche = '') {
    const container = document.getElementById('messagesListContent');
    if (!container) { console.error('âŒ Container introuvable'); return; }

    let liste = Array.from(conversations.entries()).map(([client, messages]) => {
        const dernierMsg      = messages[messages.length - 1];
        const nonLus          = messages.filter(m => m.sender === 'client' && !m.read).length;
        const contientProduit = !!(dernierMsg.product_data && Object.keys(dernierMsg.product_data).length);
        return {
            client, messages,
            dernierMessage:  dernierMsg.message || (contientProduit ? 'ğŸ“¦ Produit partagÃ©' : ''),
            date:            dernierMsg.created_at,
            nonLu:           nonLus > 0,
            countNonLus:     nonLus,
            contientProduit
        };
    });

    if (filtre === 'unread') liste = liste.filter(c => c.nonLu);
    if (recherche) {
        const q = recherche.toLowerCase();
        liste = liste.filter(c =>
            c.client.toLowerCase().includes(q) ||
            c.dernierMessage.toLowerCase().includes(q)
        );
    }
    liste.sort((a, b) => new Date(b.date) - new Date(a.date));

    const totalNonLus = liste.reduce((s, c) => s + c.countNonLus, 0);
    const unreadEl    = document.getElementById('unreadCount');
    const badge       = document.getElementById('unreadBadge');
    if (unreadEl) unreadEl.textContent = totalNonLus;
    if (badge)    { badge.textContent = totalNonLus; badge.style.display = totalNonLus > 0 ? 'flex' : 'none'; }

    if (liste.length === 0) {
        container.innerHTML = `
            <div style="padding:32px;text-align:center;color:var(--text-secondary)">
                <p style="font-size:2rem;margin-bottom:8px">ğŸ”­</p>
                <p>Aucune conversation trouvÃ©e</p>
            </div>`;
        return;
    }

    container.innerHTML = liste.map(conv => {
        const { emoji, couleur } = genererAvatarClient(conv.client);
        const isActive = conversationActive === conv.client;
        return `
            <div class="message-item${conv.nonLu ? ' unread' : ''}${isActive ? ' active' : ''}"
                 data-client="${escapeHtml(conv.client)}">
                <div class="message-avatar" style="background:${couleur}">
                    <span class="emoji-avatar">${emoji}</span>
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <span class="message-name">
                            ${escapeHtml(conv.client)}
                            ${conv.nonLu ? `<span class="unread-badge">${conv.countNonLus}</span>` : ''}
                        </span>
                        <span class="message-time">${formaterTemps(conv.date)}</span>
                    </div>
                    <div class="message-preview">
                        ${conv.contientProduit ? 'ğŸ“¦ ' : ''}${escapeHtml(conv.dernierMessage)}
                    </div>
                </div>
            </div>`;
    }).join('');

    attacherEventListenersConversations();
}

// ==================== EVENT LISTENERS LISTE (dÃ©lÃ©gation) ====================
function attacherEventListenersConversations() {
    const container = document.getElementById('messagesListContent');
    if (!container) return;

    // Retirer l'ancien listener proprement via cloneNode
    const newContainer = container.cloneNode(true);
    container.parentNode.replaceChild(newContainer, container);

    newContainer.addEventListener('click', e => {
        const item = e.target.closest('.message-item');
        if (!item) return;
        const clientName = item.dataset.client;
        if (clientName) ouvrirConversation(clientName);
    });
}

// ==================== CRÃ‰ER CARTE PRODUIT ====================
function creerCarteProduit(productData, sender) {
    const card = document.createElement('div');
    card.className = `message-product-card ${sender === 'admin' ? 'sent' : 'received'}`;

    const imageUrl = productData.image      ||
                     productData.mainImage  ||
                     productData.main_image ||
                     'https://via.placeholder.com/280x180?text=Produit';

    card.innerHTML = `
        <img src="${imageUrl}"
             class="product-card-image"
             alt="${escapeHtml(productData.nom || 'Produit')}"
             onerror="this.src='https://via.placeholder.com/280x180?text=Image+indisponible'"
             loading="lazy">
        <div class="product-card-info">
            <div class="product-card-name">${escapeHtml(productData.nom || 'Produit')}</div>
            <div style="display:flex;justify-content:space-between;align-items:center">
                <div class="product-card-price">${formatPrice(productData.prix)}</div>
                <div class="product-card-stock">ğŸ“¦ Stock: ${productData.stock ?? 0}</div>
            </div>
            <div class="product-badge">ğŸ›ï¸ Produit partagÃ©</div>
        </div>`;

    return card;
}

// ==================== OUVRIR CONVERSATION ====================
async function ouvrirConversation(clientName) {
    if (!clientName) { console.error('âŒ Nom du client manquant'); return; }

    try {
        conversationActive = clientName;
        const messages = conversations.get(clientName) || [];

        if (messages.length === 0) { console.warn('âš ï¸ Aucun message pour', clientName); return; }

        await marquerCommeLu(clientName);

        // Mobile : cacher sidebar
        if (window.innerWidth <= 768) {
            document.querySelector('.messages-sidebar')?.classList.add('mobile-hidden');
            document.getElementById('conversationPanel')?.classList.add('mobile-show');
        }

        const { emoji, couleur } = genererAvatarClient(clientName);
        const panel = document.getElementById('conversationPanel');
        if (!panel) { console.error('âŒ Panel introuvable'); return; }

        panel.innerHTML = `
            <div class="conversation-header">
                <button class="mobile-back-btn" id="mobileBackBtn">â† Retour</button>
                <div class="conversation-info">
                    <div class="conversation-avatar" style="background:${couleur}">
                        <span class="emoji-avatar">${emoji}</span>
                    </div>
                    <div class="conversation-details">
                        <h3>${escapeHtml(clientName)}</h3>
                        <div class="conversation-status">${messages.length} message(s)</div>
                    </div>
                </div>
                <div class="conversation-actions">
                    <button class="action-btn" id="deleteConvBtn">ğŸ—‘ï¸ Supprimer</button>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea class="chat-input" id="messageInput"
                              placeholder="Tapez votre rÃ©ponse..." rows="1"></textarea>
                    <button class="send-btn" id="sendBtn">Envoyer â¤</button>
                </div>
            </div>`;

        // âœ… FIX : afficherMessagesAvecProduits dans le try
        afficherMessagesAvecProduits(messages);
        attacherEventListenersConversation(clientName);

        requestAnimationFrame(() => {
            const chat = document.getElementById('chatMessages');
            if (chat) chat.scrollTop = chat.scrollHeight;
        });

        afficherListeConversations(
            document.querySelector('.filter-btn.active')?.dataset.filter || 'all',
            document.getElementById('searchMessages')?.value || ''
        );

        console.log('âœ… Conversation ouverte:', clientName);

    } catch (err) {
        console.error('âŒ Erreur ouverture conversation:', err);
        afficherNotification('âŒ Erreur d\'ouverture de la conversation', 'error');
    }
}

// ==================== AFFICHER MESSAGES AVEC PRODUITS ====================
function afficherMessagesAvecProduits(messages) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;

    const fragment   = document.createDocumentFragment();
    let dateActuelle = null;

    messages.forEach((msg, index) => {
        const dateMsg = new Date(msg.created_at);
        const dateStr = dateMsg.toLocaleDateString('fr-FR', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });

        if (dateStr !== dateActuelle) {
            const sep = document.createElement('div');
            sep.className   = 'message-date';
            sep.textContent = dateStr;
            sep.style.animation = `fadeIn .4s ease ${index * 0.02}s backwards`;
            fragment.appendChild(sep);
            dateActuelle = dateStr;
        }

        const group = document.createElement('div');
        group.className   = `message-group ${msg.sender === 'admin' ? 'sent' : 'received'}`;
        group.style.animation = `fadeIn .4s ease ${index * 0.03}s backwards`;

        if (msg.product_data && Object.keys(msg.product_data).length > 0) {
            group.appendChild(creerCarteProduit(msg.product_data, msg.sender));
        }

        if (msg.message?.trim()) {
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${msg.sender === 'admin' ? 'sent' : 'received'}`;

            const text = document.createElement('div');
            text.className   = 'message-text';
            text.textContent = msg.message;

            const time = document.createElement('div');
            time.className   = 'message-time';
            time.textContent = formaterHeure(dateMsg);

            if (msg.sender === 'admin') {
                const status = document.createElement('span');
                status.innerHTML   = msg.read ? 'âœ“âœ“' : 'âœ“';
                status.style.color = msg.read ? 'var(--primary-color)' : 'inherit';
                time.appendChild(status);
            }

            bubble.appendChild(text);
            bubble.appendChild(time);
            group.appendChild(bubble);
        }

        fragment.appendChild(group);
    });

    chatMessages.innerHTML = '';
    chatMessages.appendChild(fragment);

    requestAnimationFrame(() => { chatMessages.scrollTop = chatMessages.scrollHeight; });
}

// ==================== EVENT LISTENERS CONVERSATION ====================
function attacherEventListenersConversation(clientName) {
    document.getElementById('mobileBackBtn')?.addEventListener('click', e => {
        e.preventDefault(); retourListeMobile();
    });
    document.getElementById('deleteConvBtn')?.addEventListener('click', e => {
        e.preventDefault(); supprimerConversation(clientName);
    });
    document.getElementById('sendBtn')?.addEventListener('click', e => {
        e.preventDefault(); envoyerReponse(clientName);
    });

    const input = document.getElementById('messageInput');
    if (input) {
        input.addEventListener('keypress', e => {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); envoyerReponse(clientName); }
        });
        input.focus();
    }
}

// ==================== MARQUER COMME LU ====================
async function marquerCommeLu(clientName) {
    try {
        const msgs   = conversations.get(clientName) || [];
        const nonLus = msgs.filter(m => m.sender === 'client' && !m.read);
        if (nonLus.length === 0) return;

        const { error } = await supabase
            .from('conversations')
            .update({ read: true })
            .eq('client_name', clientName)
            .eq('user_id', currentUser.id)
            .eq('sender', 'client')
            .eq('read', false);

        if (error) throw error;
        nonLus.forEach(m => { m.read = true; });
        console.log(`âœ… ${nonLus.length} message(s) marquÃ©(s) comme lu(s)`);
    } catch (err) {
        console.error('âŒ Erreur marquage lu:', err);
    }
}

// ==================== ENVOYER RÃ‰PONSE ====================
async function envoyerReponse(clientName) {
    const input   = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    if (!input || !sendBtn) { console.error('âŒ Ã‰lÃ©ments introuvables'); return; }

    const texte = input.value.trim();
    if (!texte) { afficherNotification('âš ï¸ Veuillez saisir un message', 'warning'); return; }

    input.disabled = sendBtn.disabled = true;
    sendBtn.textContent = 'â³ Envoi...';

    try {
        const { data, error } = await supabase
            .from('conversations')
            .insert({
                user_id: currentUser.id, client_name: clientName,
                sender: 'admin', message: texte, read: true
            })
            .select().single();

        if (error) throw error;

        if (!conversations.has(clientName)) conversations.set(clientName, []);
        conversations.get(clientName).push(data);

        input.value = '';
        input.style.height = 'auto';
        ouvrirConversation(clientName);
        afficherNotification('âœ… RÃ©ponse envoyÃ©e !', 'success');

    } catch (err) {
        console.error('âŒ Erreur envoi:', err);
        afficherNotification('âŒ Erreur d\'envoi', 'error');
    } finally {
        input.disabled = sendBtn.disabled = false;
        sendBtn.textContent = 'Envoyer â¤';
        input.focus();
    }
}

// ==================== SUPPRIMER CONVERSATION ====================
async function supprimerConversation(clientName) {
    if (!confirm(`Supprimer dÃ©finitivement la conversation avec ${clientName} ?`)) return;

    try {
        const { error } = await supabase
            .from('conversations')
            .delete()
            .eq('client_name', clientName)
            .eq('user_id', currentUser.id);

        if (error) throw error;

        conversations.delete(clientName);
        conversationActive = null;

        const panel = document.getElementById('conversationPanel');
        if (panel) panel.innerHTML = `
            <div class="empty-conversation">
                <div class="empty-icon">ğŸ’¬</div>
                <h3>SÃ©lectionnez une conversation</h3>
                <p>Choisissez un message dans la liste pour commencer</p>
            </div>`;

        if (window.innerWidth <= 768) retourListeMobile();
        afficherListeConversations();
        afficherNotification('ğŸ—‘ï¸ Conversation supprimÃ©e', 'success');

    } catch (err) {
        console.error('âŒ Erreur suppression:', err);
        afficherNotification('âŒ Erreur de suppression', 'error');
    }
}

// ==================== POLLING TEMPS RÃ‰EL ====================
function demarrerPolling() {
    if (pollingInterval) clearInterval(pollingInterval);

    pollingInterval = setInterval(async () => {
        await chargerConversations();

        if (notificationChecker?.checkNewMessages) {
            notificationChecker.checkNewMessages(conversations);
        }

        if (conversationActive && conversations.has(conversationActive)) {
            const nbAffiches = document.querySelectorAll('#chatMessages .message-group').length;
            const nbTotal    = conversations.get(conversationActive).length;
            if (nbTotal > nbAffiches) ouvrirConversation(conversationActive);
        }
    }, 5000);

    console.log('âœ… Polling dÃ©marrÃ© (5s)');
}

// ==================== RECHERCHE ====================
function initialiserRecherche() {
    document.getElementById('searchMessages')?.addEventListener('input', e => {
        const filtre = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
        afficherListeConversations(filtre, e.target.value);
    });
}

// ==================== FILTRES ====================
function initialiserFiltres() {
    const filtres = document.querySelectorAll('.filter-btn');
    filtres.forEach(btn => {
        btn.addEventListener('click', () => {
            filtres.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const recherche = document.getElementById('searchMessages')?.value || '';
            afficherListeConversations(btn.dataset.filter, recherche);
        });
    });
}

// ==================== TEXTAREA AUTO-RESIZE ====================
function initialiserTextareaAutoResize() {
    document.addEventListener('input', e => {
        if (e.target.id !== 'messageInput') return;
        e.target.style.height = 'auto';
        e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px';
    });
}

// ==================== MOBILE ====================
function retourListeMobile() {
    document.querySelector('.messages-sidebar')?.classList.remove('mobile-hidden');
    document.getElementById('conversationPanel')?.classList.remove('mobile-show');
}

window.addEventListener('resize', () => {
    if (window.innerWidth > 768) retourListeMobile();
});

// ==================== CORRECTIF CLAVIER VIRTUEL MOBILE ====================
// âœ… RÃ©sout le problÃ¨me de la zone de saisie cachÃ©e sous le clavier iOS/Android
function initialiserGestionClavierMobile() {
    // MÃ©thode 1 : visualViewport API (Chrome 61+, Safari 13+)
    if (window.visualViewport) {
        const headerH = parseInt(
            getComputedStyle(document.documentElement).getPropertyValue('--header-height')
        ) || 70;

        const onViewportChange = () => {
            const panel = document.getElementById('conversationPanel');
            if (!panel || !panel.classList.contains('mobile-show')) return;

            const vp        = window.visualViewport;
            const keyboardH = Math.max(0, window.innerHeight - vp.height - vp.offsetTop);

            panel.style.bottom = keyboardH + 'px';
            panel.style.height = (vp.height - headerH) + 'px';

            requestAnimationFrame(() => {
                const chat = document.getElementById('chatMessages');
                if (chat) chat.scrollTop = chat.scrollHeight;
            });
        };

        const resetPanel = () => {
            const panel = document.getElementById('conversationPanel');
            if (!panel) return;
            panel.style.bottom = '';
            panel.style.height = '';
        };

        window.visualViewport.addEventListener('resize', onViewportChange);
        window.visualViewport.addEventListener('scroll', onViewportChange);

        document.addEventListener('focusout', (e) => {
            if (e.target.id === 'messageInput') setTimeout(resetPanel, 300);
        });

        console.log('âœ… visualViewport clavier mobile actif');
    }

    // MÃ©thode 2 : fallback scroll sur focus (iOS 12 / anciens Android)
    document.addEventListener('focusin', (e) => {
        if (e.target.id !== 'messageInput') return;
        setTimeout(() => {
            e.target.scrollIntoView({ behavior: 'smooth', block: 'end' });
            const chat = document.getElementById('chatMessages');
            if (chat) chat.scrollTop = chat.scrollHeight;
        }, 400);
    });
}

// ==================== NETTOYAGE ====================
window.addEventListener('beforeunload', () => {
    if (pollingInterval) clearInterval(pollingInterval);
});

// ==================== UTILITAIRES ====================
function formaterTemps(dateStr) {
    const diffMs   = Date.now() - new Date(dateStr);
    const diffMins = Math.floor(diffMs / 60_000);
    const diffH    = Math.floor(diffMs / 3_600_000);
    const diffJ    = Math.floor(diffMs / 86_400_000);

    if (diffMins < 1)  return 'Ã€ l\'instant';
    if (diffMins < 60) return `Il y a ${diffMins} min`;
    if (diffH    < 24) return `Il y a ${diffH}h`;
    if (diffJ    < 7)  return `Il y a ${diffJ}j`;
    return new Date(dateStr).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
}

function formaterHeure(date) {
    return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
}

function formatPrice(price) {
    if (price == null) return 'Prix non disponible';
    return `${Number(price).toLocaleString('fr-FR')} FCFA`;
}

function escapeHtml(text) {
    if (!text) return '';
    return String(text).replace(/[&<>"']/g, c =>
        ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[c]
    );
}

// ==================== NOTIFICATION TOAST ====================
function afficherNotification(message, type = 'info') {
    let conteneur = document.getElementById('notification-container');
    if (!conteneur) {
        conteneur = document.createElement('div');
        conteneur.id = 'notification-container';
        Object.assign(conteneur.style, {
            position: 'fixed', top: '100px', right: '20px',
            zIndex: '10000', display: 'flex', flexDirection: 'column', gap: '12px'
        });
        document.body.appendChild(conteneur);
    }

    const couleurs = { success: '#4CAF50', error: '#f44336', info: '#007AFF', warning: '#FF9800' };

    const notif = document.createElement('div');
    notif.style.cssText = `
        background:white; padding:16px 24px; border-radius:12px;
        box-shadow:0 8px 25px rgba(0,122,255,.2);
        border-left:4px solid ${couleurs[type] || couleurs.info};
        animation:slideLeft .5s ease; max-width:350px;
        font-family:'Poppins',sans-serif; font-weight:500; color:#333;
    `;
    notif.textContent = message;
    conteneur.appendChild(notif);

    setTimeout(() => {
        notif.style.animation = 'fadeOut .5s ease forwards';
        setTimeout(() => notif.remove(), 500);
    }, 3000);
}

// ==================== HOOKS NOTIFICATIONS EXTERNES ====================
// âœ… Ces fonctions doivent Ãªtre exposÃ©es globalement car appelÃ©es depuis message-notifications.js
window.handleNotificationToggle = function(checkbox) {
    const sys = window.messageNotificationSystem;
    if (!sys) return;
    sys.isEnabled = checkbox.checked;
    sys.saveUserPreferences();
};

window.handleSoundToggle = function(checkbox) {
    const sys = window.messageNotificationSystem;
    if (!sys) return;
    sys.soundEnabled = checkbox.checked;
    sys.saveUserPreferences();
    if (checkbox.checked) sys.sounds?.newMessage?.play();
};

window.handleDesktopToggle = async function(checkbox) {
    const sys = window.messageNotificationSystem;
    if (!sys) return;
    if (checkbox.checked) {
        await sys.requestNotificationPermission();
        checkbox.checked = sys.notificationPermission === 'granted';
    }
    sys.desktopNotificationEnabled = checkbox.checked;
    sys.saveUserPreferences();
};

// ==================== DEBUG ====================
window.debugMessages = {
    conversations:      () => conversations,
    activeConversation: () => conversationActive,
    currentUser:        () => currentUser,
    recharger:          () => chargerConversations(),
    ouvrir:  client    => ouvrirConversation(client),
    forceReload:        () => window.location.reload(),
    testEmoji: nom => {
        const av = genererAvatarClient(nom);
        console.log(`${nom} â†’ ${av.emoji} | ${av.couleur}`);
        return av;
    },
    stats: () => {
        const total  = Array.from(conversations.values()).reduce((s, m) => s + m.length, 0);
        const nonLus = Array.from(conversations.values()).flat().filter(m => m.sender === 'client' && !m.read).length;
        console.log(`ğŸ“Š ${conversations.size} conv | ${total} messages | ${nonLus} non lus`);
    }
};

// ==================== LOGS ====================
console.log('%cğŸ’¬ Messages ODA â€” Emojis + Produits', 'color:#007AFF;font-size:18px;font-weight:bold');
console.log(`%cğŸ¨ ${TOUS_LES_EMOJIS.length} emojis | ${COULEURS_AVATAR.length} couleurs`, 'color:#E91E63');
console.log('%câœ… PrÃªt', 'color:#4CAF50;font-weight:bold');
</script>
</body>
</html>
